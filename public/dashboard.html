<!DOCTYPE html>
<!-- cache-bust: v6 -->
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insights - Navigator</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M50 20 L60 40 L80 40 L65 55 L70 75 L50 65 L30 75 L35 55 L20 40 L40 40 Z' fill='%2317A2B8'/></svg>">
    
    <!-- Google Fonts - Brand Manual Navi -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Chat Widget CSS -->
    <link rel="stylesheet" href="/css/chat-widget.css">
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Brand Manual CSS - Inline -->
    <style>
/**
 * NAVI BRAND MANUAL - Variáveis CSS
 * Sistema de Design Oficial do Navigator
 * Data: Outubro 2025
 */

:root {
  /* ===== CORES PRIMÁRIAS ===== */
  
  /* Brand Dark Grey - Cor Principal */
  --navi-primary-dark: #343A40;
  --navi-primary-dark-rgb: 52, 58, 64;
  
  /* Accent Teal - CTAs e Estados Ativos */
  --navi-accent-teal: #17A2B8;
  --navi-accent-teal-rgb: 23, 162, 184;
  --navi-accent-teal-hover: #138496;
  --navi-accent-teal-light: rgba(23, 162, 184, 0.1);
  --navi-accent-teal-medium: rgba(23, 162, 184, 0.3);
  
  /* Brand Medium Grey - Textos Secundários */
  --navi-secondary-grey: #6C7570;
  --navi-secondary-grey-rgb: 108, 117, 112;
  --navi-secondary-grey-light: #8a9490;
  
  /* Success Green - Apenas para Conclusões */
  --navi-success-green: #28A745;
  --navi-success-green-rgb: 40, 167, 69;
  --navi-success-green-light: rgba(40, 167, 69, 0.1);
  
  /* ===== CORES DE SUPORTE ===== */
  
  --navi-background: #f8fafc;
  --navi-white: #ffffff;
  --navi-border: #e2e8f0;
  --navi-border-dark: #cbd5e0;
  
  /* Cores de Alerta (opcional) */
  --navi-warning: #ffc107;
  --navi-danger: #dc3545;
  --navi-info: #17A2B8; /* Mesma do accent */
  
  /* ===== SOMBRAS ===== */
  
  --navi-shadow-sm: 0 1px 3px rgba(52, 58, 64, 0.08);
  --navi-shadow-md: 0 4px 12px rgba(52, 58, 64, 0.12);
  --navi-shadow-lg: 0 10px 24px rgba(52, 58, 64, 0.15);
  
  /* ===== RAIOS DE BORDA ===== */
  
  --navi-radius-sm: 6px;
  --navi-radius-md: 8px;
  --navi-radius-lg: 12px;
  --navi-radius-full: 9999px;
  
  /* ===== ESPAÇAMENTO (Generoso) ===== */
  
  --navi-spacing-xs: 8px;
  --navi-spacing-sm: 12px;
  --navi-spacing-md: 16px;
  --navi-spacing-lg: 24px;
  --navi-spacing-xl: 32px;
  --navi-spacing-2xl: 48px;
  
  /* ===== TRANSIÇÕES ===== */
  
  --navi-transition-fast: 0.15s ease;
  --navi-transition-base: 0.2s ease;
  --navi-transition-slow: 0.3s ease;
}

/* ===== TIPOGRAFIA ===== */

/* Títulos - Montserrat */
h1, h2, h3, h4, h5, h6 {
  font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  font-weight: 600;
  color: var(--navi-primary-dark);
  line-height: 1.3;
  margin: 0;
}

h1 {
  font-size: 32px;
  font-weight: 700;
  line-height: 1.2;
}

h2 {
  font-size: 24px;
  font-weight: 600;
  line-height: 1.3;
}

h3 {
  font-size: 20px;
  font-weight: 600;
  line-height: 1.4;
}

h4 {
  font-size: 18px;
  font-weight: 600;
}

h5 {
  font-size: 16px;
  font-weight: 600;
}

h6 {
  font-size: 14px;
  font-weight: 600;
}

/* Corpo de Texto e UI - Roboto */
body, p, span, div, button, input, select, textarea, label, a {
  font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  font-weight: 400;
  color: var(--navi-primary-dark);
}

/* UI Elements com Ênfase */
.btn, .nav-link, label, .form-label, strong, b {
  font-weight: 500; /* Medium */
}

/* Textos Secundários */
.text-secondary, .subtitle, .description, small {
  color: var(--navi-secondary-grey);
  font-weight: 400;
}

/* ===== BOTÕES ===== */

.btn {
  padding: var(--navi-spacing-sm) var(--navi-spacing-lg);
  border-radius: var(--navi-radius-md);
  font-family: 'Roboto', sans-serif;
  font-weight: 500;
  font-size: 16px;
  cursor: pointer;
  border: none;
  transition: all var(--navi-transition-base);
  display: inline-flex;
  align-items: center;
  gap: var(--navi-spacing-xs);
  text-decoration: none;
}

/* Botão Primário - Accent Teal */
.btn-primary {
  background: var(--navi-accent-teal);
  color: var(--navi-white);
  box-shadow: 0 2px 4px rgba(23, 162, 184, 0.15);
}

.btn-primary:hover {
  background: var(--navi-accent-teal-hover);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(23, 162, 184, 0.25);
}

.btn-primary:active {
  transform: translateY(0);
}

/* Botão Secundário */
.btn-secondary {
  background: var(--navi-white);
  color: var(--navi-secondary-grey);
  border: 1px solid var(--navi-border);
}

.btn-secondary:hover {
  border-color: var(--navi-accent-teal);
  color: var(--navi-accent-teal);
  background: var(--navi-accent-teal-light);
}

/* Botão de Sucesso */
.btn-success {
  background: var(--navi-success-green);
  color: var(--navi-white);
  box-shadow: 0 2px 4px rgba(40, 167, 69, 0.15);
}

.btn-success:hover {
  background: #218838;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(40, 167, 69, 0.25);
}

/* ===== CARDS ===== */

.card {
  background: var(--navi-white);
  border: 1px solid var(--navi-border);
  border-radius: var(--navi-radius-lg);
  padding: var(--navi-spacing-lg);
  margin-bottom: var(--navi-spacing-lg);
  box-shadow: var(--navi-shadow-sm);
  transition: all var(--navi-transition-base);
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: var(--navi-shadow-md);
}

.card-title {
  font-family: 'Montserrat', sans-serif;
  font-weight: 600;
  font-size: 20px;
  color: var(--navi-primary-dark);
  margin-bottom: var(--navi-spacing-md);
}

.card-subtitle {
  font-family: 'Roboto', sans-serif;
  font-weight: 400;
  font-size: 14px;
  color: var(--navi-secondary-grey);
  margin-bottom: var(--navi-spacing-sm);
}

/* ===== NAVEGAÇÃO ===== */

.nav-link {
  display: flex;
  align-items: center;
  gap: var(--navi-spacing-sm);
  padding: var(--navi-spacing-sm) var(--navi-spacing-lg);
  color: var(--navi-secondary-grey);
  font-family: 'Roboto', sans-serif;
  font-weight: 400;
  font-size: 16px;
  text-decoration: none;
  border-left: 3px solid transparent;
  transition: all var(--navi-transition-base);
}

.nav-link:hover {
  background: var(--navi-accent-teal-light);
  color: var(--navi-accent-teal);
}

.nav-link.active {
  background: var(--navi-accent-teal-light);
  color: var(--navi-accent-teal);
  border-left-color: var(--navi-accent-teal);
  font-weight: 500;
}

/* ===== BADGES ===== */

.badge {
  display: inline-flex;
  align-items: center;
  padding: 4px 12px;
  border-radius: var(--navi-radius-full);
  font-size: 12px;
  font-weight: 500;
  line-height: 1;
}

.badge-primary {
  background: var(--navi-accent-teal-light);
  color: var(--navi-accent-teal);
}

.badge-success {
  background: var(--navi-success-green-light);
  color: var(--navi-success-green);
}

.badge-secondary {
  background: #f1f5f9;
  color: var(--navi-secondary-grey);
}

/* ===== INDICADORES DE PROGRESSO ===== */

.progress-bar {
  width: 100%;
  height: 8px;
  background: var(--navi-border);
  border-radius: var(--navi-radius-sm);
  overflow: hidden;
}

.progress-bar-fill {
  height: 100%;
  background: var(--navi-accent-teal);
  transition: width var(--navi-transition-slow);
  border-radius: var(--navi-radius-sm);
}

/* ===== UTILITÁRIOS ===== */

/* Cores de Texto */
.text-primary { color: var(--navi-primary-dark); }
.text-accent { color: var(--navi-accent-teal); }
.text-secondary { color: var(--navi-secondary-grey); }
.text-success { color: var(--navi-success-green); }
.text-white { color: var(--navi-white); }

/* Cores de Background */
.bg-primary { background-color: var(--navi-primary-dark); }
.bg-accent { background-color: var(--navi-accent-teal); }
.bg-secondary { background-color: var(--navi-secondary-grey); }
.bg-success { background-color: var(--navi-success-green); }
.bg-light { background-color: var(--navi-background); }
.bg-white { background-color: var(--navi-white); }

/* Espaçamentos */
.p-sm { padding: var(--navi-spacing-sm); }
.p-md { padding: var(--navi-spacing-md); }
.p-lg { padding: var(--navi-spacing-lg); }
.p-xl { padding: var(--navi-spacing-xl); }

.m-sm { margin: var(--navi-spacing-sm); }
.m-md { margin: var(--navi-spacing-md); }
.m-lg { margin: var(--navi-spacing-lg); }
.m-xl { margin: var(--navi-spacing-xl); }

/* Sombras */
.shadow-sm { box-shadow: var(--navi-shadow-sm); }
.shadow-md { box-shadow: var(--navi-shadow-md); }
.shadow-lg { box-shadow: var(--navi-shadow-lg); }

/* Arredondamento */
.rounded-sm { border-radius: var(--navi-radius-sm); }
.rounded-md { border-radius: var(--navi-radius-md); }
.rounded-lg { border-radius: var(--navi-radius-lg); }
.rounded-full { border-radius: var(--navi-radius-full); }

/* ===== TABELAS ===== */

.navi-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: var(--navi-spacing-md);
}

.navi-table th,
.navi-table td {
  text-align: left;
  padding: 12px;
  border-bottom: 1px solid #e2e8f0;
}

.navi-table th {
  background: #f8fafc;
  font-weight: 600;
  color: #374151;
}

.navi-table tbody tr:hover {
  background: #f8fafc;
}

/* ===== ANIMAÇÕES ===== */

* {
  transition-timing-function: ease;
}

.interactive {
  transition: transform var(--navi-transition-base);
}

.interactive:hover {
  transform: translateY(-1px);
}

.card-hover {
  transition: all var(--navi-transition-base);
}

.card-hover:hover {
  transform: translateY(-2px);
  box-shadow: var(--navi-shadow-md);
}

@keyframes fade-in {
  from { opacity: 0; }
  to { opacity: 1; }
}

.fade-in {
  animation: fade-in 0.2s ease-in;
}

@keyframes slide-in-top {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.slide-in-top {
  animation: slide-in-top 0.3s ease-out;
}

@keyframes success-flash {
  0% {
    background: var(--navi-success-green-light);
    border-color: var(--navi-success-green);
  }
  50% {
    background: var(--navi-success-green);
    color: var(--navi-white);
  }
  100% {
    background: var(--navi-white);
    border-color: var(--navi-border);
    color: var(--navi-secondary-grey);
  }
}

.task-completed {
  animation: success-flash 2s ease-in-out;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.spinner {
  animation: spin 1s linear infinite;
}

*:focus {
  outline: 2px solid var(--navi-accent-teal);
  outline-offset: 2px;
}

button:focus, 
input:focus, 
select:focus, 
textarea:focus {
  outline: 2px solid var(--navi-accent-teal);
  outline-offset: 2px;
}

button:not(:disabled):hover,
a:hover {
  transition: all var(--navi-transition-base);
}
    </style>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--navi-background);
            color: var(--navi-primary-dark);
        }
        
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: var(--navi-white);
            border-right: 1px solid var(--navi-border);
            padding: var(--navi-spacing-xl) 0;
            z-index: 100;
            transition: width var(--navi-transition-slow);
        }
        
        .sidebar.collapsed {
            width: 80px;
        }
        
        .sidebar-toggle {
            position: absolute;
            top: var(--navi-spacing-md);
            right: var(--navi-spacing-md);
            background: var(--navi-background);
            border: none;
            border-radius: var(--navi-radius-sm);
            padding: var(--navi-spacing-sm);
            cursor: pointer;
            transition: all var(--navi-transition-base);
        }
        
        .sidebar-toggle:hover {
            background: var(--navi-border);
        }
        
        .sidebar-header {
            padding: 0 var(--navi-spacing-xl);
            margin-bottom: var(--navi-spacing-xl);
            transition: padding var(--navi-transition-slow);
        }
        
        .sidebar.collapsed .sidebar-header {
            padding: 0 1rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
            color: var(--navi-primary-dark);
            transition: all 0.3s ease;
        }
        
        .sidebar.collapsed .logo {
            font-size: 1rem;
            justify-content: center;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            flex-shrink: 0;
        }
        
        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .sidebar.collapsed .logo-icon {
            width: 32px;
            height: 32px;
            font-size: 1rem;
        }
        
        .nav-text {
            transition: all 0.3s ease;
        }
        
        .sidebar.collapsed .nav-text {
            display: none;
        }
        
        .tenant-info {
            margin-top: var(--navi-spacing-md);
            padding: var(--navi-spacing-md);
            background: var(--navi-background);
            border-radius: var(--navi-radius-md);
            border-left: 4px solid var(--navi-accent-teal);
            transition: all var(--navi-transition-slow);
        }
        
        .sidebar.collapsed .tenant-info {
            padding: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .tenant-info h3 {
            font-size: 0.9rem;
            color: var(--navi-secondary-grey);
            margin-bottom: 0.25rem;
            transition: all var(--navi-transition-slow);
        }
        
        .sidebar.collapsed .tenant-info h3 {
            font-size: 0.7rem;
            text-align: center;
        }
        
        .tenant-info p {
            font-size: 0.8rem;
            color: var(--navi-secondary-grey);
            transition: all var(--navi-transition-slow);
        }
        
        .sidebar.collapsed .tenant-info p {
            display: none;
        }
        
        .nav-menu {
            list-style: none;
            transition: all 0.3s ease;
        }
        
        .nav-item {
            margin-bottom: 0.5rem;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: var(--navi-spacing-sm);
            padding: var(--navi-spacing-sm) var(--navi-spacing-xl);
            color: var(--navi-secondary-grey);
            text-decoration: none;
            transition: all var(--navi-transition-base);
            border-left: 3px solid transparent;
            position: relative;
        }
        
        .sidebar.collapsed .nav-link {
            padding: 0.75rem 1rem;
            justify-content: center;
        }
        
        .nav-link:hover {
            background: var(--navi-accent-teal-light);
            color: var(--navi-accent-teal);
        }
        
        .nav-link.active {
            background: var(--navi-accent-teal-light);
            color: var(--navi-accent-teal);
            border-left-color: var(--navi-accent-teal);
        }
        
        .nav-icon {
            font-size: 1.2rem;
            width: 20px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            transition: margin-left var(--navi-transition-slow);
        }
        
        .sidebar.collapsed + .main-content {
            margin-left: 80px;
        }
        
        .top-bar {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .content {
            padding: 2rem;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .section-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .btn-primary {
            background: var(--navi-accent-teal);
            color: var(--navi-white);
            border: none;
            padding: var(--navi-spacing-sm) var(--navi-spacing-lg);
            border-radius: var(--navi-radius-md);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--navi-transition-base);
        }
        
        .btn-primary:hover {
            background: var(--navi-accent-teal-hover);
        }
        
        .btn-secondary {
            background: var(--navi-accent-teal);
            color: var(--navi-white);
            border: none;
            padding: var(--navi-spacing-sm) var(--navi-spacing-md);
            border-radius: 8px !important;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Roboto', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: var(--navi-spacing-xs);
        }
        
        .btn-secondary:hover {
            background: var(--navi-accent-teal-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        }
        
        /* Forçar border-radius em todos os botões */
        button {
            border-radius: 8px !important;
        }
        
        .btn-primary {
            border-radius: 8px !important;
        }
        
        .btn-secondary {
            border-radius: 8px !important;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--navi-accent-teal);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--navi-secondary-grey);
            font-size: 0.9rem;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Tooltip para menu recolhido */
        .sidebar.collapsed .nav-link::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: #1e293b;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 1000;
            margin-left: 0.5rem;
        }
        
        .sidebar.collapsed .nav-link:hover::after {
            opacity: 1;
            visibility: visible;
        }
        
        /* Registration Routine Styles */
        .routine-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .routine-item:hover {
            border-color: #2563eb;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.1);
        }
        
        .routine-icon {
            font-size: 2rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8fafc;
            border-radius: 8px;
            flex-shrink: 0;
        }
        
        .routine-text h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }
        
        .routine-text p {
            font-size: 0.9rem;
            color: #64748b;
            margin: 0;
        }
        
        /* Inline editing styles */
        .inline-row {
            background: #f8fafc !important;
            border: 2px solid #e2e8f0 !important;
        }
        
        .inline-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .btn-inline-save {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .btn-inline-cancel {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .btn-inline-save:hover {
            background: #059669;
        }
        
        .btn-inline-cancel:hover {
            background: #dc2626;
        }
        
        .btn-edit {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.8rem;
            margin-right: 0.5rem;
        }
        
        .btn-edit:hover {
            background: #2563eb;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .btn-delete:hover {
            background: #dc2626;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* ===== ESTILOS PARA DASHBOARD UNIFICADO ===== */
        
        /* Grid expandido para métricas principais */
        .stats-grid-expanded {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Seção de gráficos */
        .charts-section {
            margin-bottom: 2rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .chart-header h3 {
            margin: 0;
            font-size: 16px;
            color: #374151;
        }

        .chart-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .form-select-sm {
            padding: 0.25rem 0.5rem;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
        }

        /* Seção de tabelas */
        .tables-section {
            margin-bottom: 2rem;
        }

        .tables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 1.5rem;
        }

        .table-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .table-header h3 {
            margin: 0;
            font-size: 16px;
            color: #374151;
        }

        .table-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .form-input-sm {
            padding: 0.25rem 0.5rem;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            width: 150px;
        }

        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f3f4f6;
            padding: 0.75rem;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 0.75rem;
            font-size: 13px;
            color: #6b7280;
            border-bottom: 1px solid #f3f4f6;
        }

        .data-table tr:hover {
            background: #f9fafb;
        }

        .table-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
        }

        .table-pagination button {
            padding: 0.5rem 1rem;
            font-size: 12px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }

        .table-pagination button:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .table-pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .table-pagination span {
            font-size: 12px;
            color: #6b7280;
        }

        /* Cores específicas para cards de métricas */
        .stat-card.primary { border-left: 4px solid #3b82f6; }
        .stat-card.info { border-left: 4px solid #06b6d4; }
        .stat-card.success { border-left: 4px solid #10b981; }
        .stat-card.warning { border-left: 4px solid #f59e0b; }
        .stat-card.danger { border-left: 4px solid #ef4444; }
        .stat-card.critical { border-left: 4px solid #dc2626; }

        /* Responsividade */
        @media (max-width: 768px) {
            .stats-grid-expanded {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 1rem;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .tables-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 250px;
            }
        }

        /* ===== ESTILOS PARA SEÇÃO DE PROATIVIDADE ===== */
        
        /* Badge pulsante para alertas */
        .badge-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Cards de métricas com hover effects */
        .stat-card {
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        /* Cores por severidade */
        .stat-card.critical { border-left: 4px solid #ef4444; }
        .stat-card.warning { border-left: 4px solid #f59e0b; }
        .stat-card.info { border-left: 4px solid #3b82f6; }
        .stat-card.success { border-left: 4px solid #10b981; }

        /* Timeline de atividades */
        .activity-timeline {
            position: relative;
            padding-left: 30px;
        }

        .activity-item {
            position: relative;
            padding-bottom: 20px;
        }

        .activity-item::before {
            content: '';
            position: absolute;
            left: -23px;
            top: 0;
            width: 2px;
            height: 100%;
            background: #e5e7eb;
        }

        .activity-dot {
            position: absolute;
            left: -30px;
            top: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 0 2px currentColor;
        }

        /* Cards expansíveis */
        .expandable-card {
            transition: max-height 0.3s ease;
            overflow: hidden;
        }

        .expandable-card.collapsed {
            max-height: 80px;
        }

        /* Score de risco visual */
        .risk-score-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .risk-score-fill {
            height: 100%;
            transition: width 0.5s ease, background-color 0.3s ease;
            border-radius: 4px;
        }

        .risk-score-fill.low { background: linear-gradient(90deg, #10b981, #34d399); }
        .risk-score-fill.medium { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .risk-score-fill.high { background: linear-gradient(90deg, #f97316, #fb923c); }
        .risk-score-fill.critical { background: linear-gradient(90deg, #ef4444, #f87171); }

        /* Botões de ação inline */
        .action-buttons {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .action-card:hover .action-buttons {
            opacity: 1;
        }

        /* Loading skeleton */
        .skeleton {
            animation: skeleton-loading 1s linear infinite alternate;
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 10px;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        /* Hover effects para notificações */
        .notification-bell:hover {
            background-color: var(--navi-accent-teal-light);
        }

        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--navi-border);
            border-radius: var(--navi-radius-md);
            box-shadow: var(--navi-shadow-lg);
            width: 350px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
        }

        .notification-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .notification-item:hover {
            background-color: #f9fafb;
        }

        .notification-item.unread {
            background-color: var(--navi-accent-teal-light);
        }

        .notification-item.unread:hover {
            background-color: var(--navi-accent-teal-medium);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <span id="toggle-icon">←</span>
        </button>
        
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">
                    <svg width="48" height="32" viewBox="0 0 48 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <!-- Grupo do logo compacto -->
                      <g transform="translate(24, 20)">
                        <!-- Texto "NAV" -->
                        <text
                          font-family="Montserrat, Arial, sans-serif"
                          font-weight="700"
                          font-size="16"
                          fill="#343A40"
                          text-anchor="middle"
                          y="3">NAV</text>

                        <!-- Letra "I" -->
                        <text
                          font-family="Montserrat, Arial, sans-serif"
                          font-weight="700"
                          font-size="16"
                          fill="#343A40"
                          x="20"
                          y="3">I</text>

                        <!-- Caret com accent teal -->
                        <path
                          d="M20 -4 L21.5 -7 L23 -4"
                          stroke="#17A2B8"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          fill="none"/>
                      </g>
                </svg>
                </div>
                <span class="nav-text">Navigator</span>
            </div>
            <div class="tenant-info">
                <h3 id="tenantName">Carregando...</h3>
                <p id="tenantSubdomain">Carregando...</p>
            </div>
        </div>
        
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="dashboard.html" class="nav-link active" data-tooltip="Insights do Navî">
                    <i data-feather="bar-chart-2" class="nav-icon"></i>
                    <span class="nav-text">Insights</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="funcionarios.html" class="nav-link" data-tooltip="Colaboradores">
                    <i data-feather="users" class="nav-icon"></i>
                    <span class="nav-text">Colaboradores</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="admin-trilhas.html" class="nav-link" data-tooltip="Trilhas">
                    <i data-feather="layers" class="nav-icon"></i>
                    <span class="nav-text">Trilhas</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="documentos.html" class="nav-link" data-tooltip="Documentos">
                    <i data-feather="file-text" class="nav-icon"></i>
                    <span class="nav-text">Documentos</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="configurador.html" class="nav-link" data-tooltip="Configurações">
                    <i data-feather="settings" class="nav-icon"></i>
                    <span class="nav-text">Configurações</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Bar -->
        <header class="top-bar">
            <h1 id="pageTitle">Insights do Navî</h1>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <!-- Sino de Notificações -->
                <div class="notification-bell" onclick="toggleNotifications()" style="position: relative; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: background-color 0.2s;">
                    <i data-feather="bell" style="width: 20px; height: 20px; color: var(--navi-secondary-grey);"></i>
                    <span id="notificationBadge" class="badge" style="position: absolute; top: 0; right: 0; background: var(--navi-danger); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; min-width: 16px; text-align: center; display: none;">0</span>
                </div>
                
                <!-- Dropdown de Notificações -->
                <div id="notificationDropdown" class="notification-dropdown" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid var(--navi-border); border-radius: var(--navi-radius-md); box-shadow: var(--navi-shadow-lg); width: 350px; max-height: 400px; overflow-y: auto; z-index: 1000;">
                    <div class="notification-header" style="padding: 1rem; border-bottom: 1px solid var(--navi-border); display: flex; justify-content: space-between; align-items: center;">
                        <h4 style="margin: 0; font-size: 14px; color: var(--navi-primary-dark);">Notificações</h4>
                        <button onclick="marcarTodasLidas()" style="background: none; border: none; color: var(--navi-accent-teal); font-size: 12px; cursor: pointer;">Marcar todas como lidas</button>
                    </div>
                    <div id="notificationList" style="max-height: 300px; overflow-y: auto;">
                        <!-- Notificações serão carregadas aqui -->
                    </div>
                </div>
                
                <span id="currentTime"></span>
            </div>
        </header>

        <!-- Content -->
        <div class="content">
            <!-- Dashboard Unificado com Proatividade Integrada -->
            <div id="insights-section" class="section active">
                <!-- Header dinâmico com status em tempo real -->
                <div class="section-header">
                    <div>
                        <h2>📊 Dashboard Executivo</h2>
                        <p class="text-muted">
                            <span id="lastUpdate">Carregando...</span>
                            <span class="badge badge-sm success">Auto-refresh: 5min</span>
                        </p>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <select id="dashboard-filter" onchange="filterDashboardData()" class="form-select">
                            <option value="all">Todos</option>
                            <option value="critical">Críticos</option>
                            <option value="pending">Pendentes</option>
                            <option value="today">Hoje</option>
                        </select>
                        <button class="btn-secondary" onclick="manualRefresh()" id="refreshBtn">
                            <i data-feather="refresh-cw"></i>
                            Atualizar
                        </button>
                    </div>
                </div>

                <!-- Cards de métricas principais expandidos -->
                <div class="stats-grid-expanded">
                    <div class="stat-card primary" onclick="filterByType('trilhas')" data-tooltip="Ver trilhas ativas">
                        <div class="stat-icon">🎯</div>
                        <div class="stat-value" id="trilhasAtivas">
                            <div class="skeleton" style="width: 60px; height: 32px;"></div>
                    </div>
                        <div class="stat-label">Trilhas Ativas</div>
                        <div class="stat-trend" id="trilhasTrend"></div>
                    </div>
                    <div class="stat-card info" onclick="filterByType('usuarios')" data-tooltip="Ver usuários em onboarding">
                        <div class="stat-icon">👥</div>
                        <div class="stat-value" id="usuariosOnboarding">
                            <div class="skeleton" style="width: 60px; height: 32px;"></div>
                    </div>
                        <div class="stat-label">Usuários em Onboarding</div>
                        <div class="stat-trend" id="usuariosTrend"></div>
                    </div>
                    <div class="stat-card success" onclick="filterByType('melhorias')" data-tooltip="Ver melhorias sugeridas">
                        <div class="stat-icon">💡</div>
                        <div class="stat-value" id="melhoriasSugeridas">
                            <div class="skeleton" style="width: 60px; height: 32px;"></div>
                        </div>
                        <div class="stat-label">Melhorias Sugeridas</div>
                        <div class="stat-trend" id="melhoriasTrend"></div>
                    </div>
                    <div class="stat-card warning" onclick="filterByType('sentimento')" data-tooltip="Ver análise de sentimento">
                        <div class="stat-icon">📈</div>
                        <div class="stat-value" id="sentimentoMedio">
                            <div class="skeleton" style="width: 60px; height: 32px;"></div>
                        </div>
                        <div class="stat-label">Sentimento Médio</div>
                        <div class="stat-trend" id="sentimentoTrend"></div>
                    </div>
                    <div class="stat-card danger" onclick="filterByType('alertas')" data-tooltip="Ver alertas críticos">
                        <div class="stat-icon">🚨</div>
                        <div class="stat-value" id="alertasAtivos">
                            <div class="skeleton" style="width: 60px; height: 32px;"></div>
                        </div>
                        <div class="stat-label">Alertas Ativos</div>
                        <div class="stat-trend" id="alertasTrend"></div>
                    </div>
                    <div class="stat-card critical" onclick="filterByType('risco')" data-tooltip="Ver colaboradores em risco">
                        <div class="stat-icon">⚠️</div>
                        <div class="stat-value" id="colaboradoresRisco">
                            <div class="skeleton" style="width: 60px; height: 32px;"></div>
                        </div>
                        <div class="stat-label">Colaboradores em Risco</div>
                        <div class="stat-trend" id="riscoTrend"></div>
                    </div>
                </div>

                <!-- Seção de Gráficos Dinâmicos -->
                <div class="charts-section">
                    <div class="charts-grid">
                        <!-- Trilhas por Cargo -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>📊 Trilhas por Cargo</h3>
                                <div class="chart-controls">
                                    <select id="trilhasCargoFilter" onchange="updateTrilhasCargoChart()" class="form-select-sm">
                                        <option value="ativo">Ativas</option>
                                        <option value="concluido">Concluídas</option>
                                        <option value="atrasado">Atrasadas</option>
                                    </select>
                        </div>
                    </div>
                            <div class="chart-container">
                                <canvas id="trilhasCargoChart"></canvas>
                        </div>
                        </div>

                        <!-- Sentimento por Cargo -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>😊 Sentimento por Cargo</h3>
                                <div class="chart-controls">
                                    <select id="sentimentoCargoFilter" onchange="updateSentimentoCargoChart()" class="form-select-sm">
                                        <option value="7">Últimos 7 dias</option>
                                        <option value="30">Últimos 30 dias</option>
                                        <option value="90">Últimos 90 dias</option>
                                    </select>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="sentimentoCargoChart"></canvas>
                    </div>
                </div>

                        <!-- Alertas por Severidade -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>🚨 Alertas por Severidade</h3>
                                <div class="chart-controls">
                                    <select id="alertasSeveridadeFilter" onchange="updateAlertasSeveridadeChart()" class="form-select-sm">
                                        <option value="24">Últimas 24h</option>
                                        <option value="7">Últimos 7 dias</option>
                                        <option value="30">Últimos 30 dias</option>
                                    </select>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="alertasSeveridadeChart"></canvas>
                            </div>
                        </div>

                        <!-- Tendência de Engajamento -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>📈 Tendência de Engajamento</h3>
                                <div class="chart-controls">
                                    <select id="engajamentoFilter" onchange="updateEngajamentoChart()" class="form-select-sm">
                                        <option value="7">Últimos 7 dias</option>
                                        <option value="30">Últimos 30 dias</option>
                                        <option value="90">Últimos 90 dias</option>
                                    </select>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="engajamentoChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seção de Tabelas com Paginação -->
                <div class="tables-section">
                    <div class="tables-grid">
                <!-- Padrões Identificados -->
                        <div class="table-card">
                            <div class="table-header">
                                <h3>🔍 Padrões Identificados</h3>
                                <div class="table-controls">
                                    <input type="text" id="padroesSearch" placeholder="Buscar padrões..." class="form-input-sm" onkeyup="searchPadroes()">
                                    <button class="btn-sm btn-outline" onclick="exportPadroes()">
                                        <i data-feather="download"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Padrão</th>
                                            <th>Tipo</th>
                                            <th>Frequência</th>
                                            <th>Impacto</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="padroesTableBody">
                                        <!-- Carregado dinamicamente -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="table-pagination">
                                <button id="padroesPrevBtn" onclick="loadPadroesPage('prev')" disabled>Anterior</button>
                                <span id="padroesPageInfo">Página 1 de 1</span>
                                <button id="padroesNextBtn" onclick="loadPadroesPage('next')" disabled>Próxima</button>
                                <button id="padroesLoadMoreBtn" onclick="loadMorePadroes()" class="btn-outline">Carregar Mais</button>
                    </div>
                </div>

                        <!-- Alertas Críticos -->
                        <div class="table-card">
                            <div class="table-header">
                                <h3>🚨 Alertas Críticos</h3>
                                <div class="table-controls">
                                    <select id="alertasFilter" onchange="filterAlertas()" class="form-select-sm">
                                        <option value="all">Todos</option>
                                        <option value="critica">Críticos</option>
                                        <option value="alta">Altos</option>
                                        <option value="media">Médios</option>
                            </select>
                                    <button class="btn-sm btn-outline" onclick="exportAlertas()">
                                        <i data-feather="download"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Alerta</th>
                                            <th>Colaborador</th>
                                            <th>Severidade</th>
                                            <th>Data</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="alertasTableBody">
                                        <!-- Carregado dinamicamente -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="table-pagination">
                                <button id="alertasPrevBtn" onclick="loadAlertasPage('prev')" disabled>Anterior</button>
                                <span id="alertasPageInfo">Página 1 de 1</span>
                                <button id="alertasNextBtn" onclick="loadAlertasPage('next')" disabled>Próxima</button>
                                <button id="alertasLoadMoreBtn" onclick="loadMoreAlertas()" class="btn-outline">Carregar Mais</button>
                            </div>
                        </div>

                        <!-- Ações Pendentes -->
                        <div class="table-card">
                            <div class="table-header">
                                <h3>⏳ Ações Pendentes</h3>
                                <div class="table-controls">
                                    <select id="acoesFilter" onchange="filterAcoes()" class="form-select-sm">
                                        <option value="all">Todas</option>
                                        <option value="pendente">Pendentes</option>
                                        <option value="aprovada">Aprovadas</option>
                                        <option value="rejeitada">Rejeitadas</option>
                            </select>
                                    <button class="btn-sm btn-outline" onclick="exportAcoes()">
                                        <i data-feather="download"></i>
                                    </button>
                        </div>
                    </div>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Ação</th>
                                            <th>Tipo</th>
                                            <th>Colaborador</th>
                                            <th>Status</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="acoesTableBody">
                                        <!-- Carregado dinamicamente -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="table-pagination">
                                <button id="acoesPrevBtn" onclick="loadAcoesPage('prev')" disabled>Anterior</button>
                                <span id="acoesPageInfo">Página 1 de 1</span>
                                <button id="acoesNextBtn" onclick="loadAcoesPage('next')" disabled>Próxima</button>
                                <button id="acoesLoadMoreBtn" onclick="loadMoreAcoes()" class="btn-outline">Carregar Mais</button>
                            </div>
                        </div>

                        <!-- Colaboradores em Risco -->
                        <div class="table-card">
                            <div class="table-header">
                                <h3>⚠️ Colaboradores em Risco</h3>
                                <div class="table-controls">
                                    <select id="riscoFilter" onchange="filterRisco()" class="form-select-sm">
                                        <option value="all">Todos</option>
                                        <option value="critico">Crítico</option>
                                        <option value="alto">Alto</option>
                                        <option value="medio">Médio</option>
                                    </select>
                                    <button class="btn-sm btn-outline" onclick="exportRisco()">
                                        <i data-feather="download"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Colaborador</th>
                                            <th>Cargo</th>
                                            <th>Score</th>
                                            <th>Fatores</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="riscoTableBody">
                                        <!-- Carregado dinamicamente -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="table-pagination">
                                <button id="riscoPrevBtn" onclick="loadRiscoPage('prev')" disabled>Anterior</button>
                                <span id="riscoPageInfo">Página 1 de 1</span>
                                <button id="riscoNextBtn" onclick="loadRiscoPage('next')" disabled>Próxima</button>
                                <button id="riscoLoadMoreBtn" onclick="loadMoreRisco()" class="btn-outline">Carregar Mais</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal de detalhes (overlay) -->
                <div id="detailsModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="modalTitle"></h3>
                            <button onclick="closeModal()" class="btn-close">&times;</button>
                        </div>
                        <div class="modal-body" id="modalBody"></div>
                        <div class="modal-footer" id="modalFooter"></div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="users-section" class="section hidden">
                <div class="section-header">
                    <h2>Colaboradores</h2>
                    <button class="btn-primary">+ Novo Colaborador</button>
                </div>
                <div class="card">
                    <p>Funcionalidade de colaboradores em desenvolvimento...</p>
                </div>
            </div>

            <!-- Documents Section -->
            <div id="documents-section" class="section hidden">
                <div class="section-header">
                    <h2>Documentos</h2>
                    <button class="btn-primary">+ Novo Documento</button>
                </div>
                <div class="card">
                    <p>Funcionalidade de documentos em desenvolvimento...</p>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings-section" class="section hidden">
                <div class="section-header">
                    <h2>Configurações</h2>
                </div>
                
                <!-- Main Settings View -->
                <div id="settings-main">
                    <div class="card">
                        <h3>Informações da Empresa</h3>
                        <div style="margin-bottom: 1rem;">
                            <label><strong>Nome da Empresa:</strong></label>
                            <p id="companyName">Empresa Demo</p>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label><strong>Subdomínio:</strong></label>
                            <p id="companySubdomain">demo.flowly.com</p>
                        </div>
                        <div style="background: #dcfce7; padding: 1rem; border-radius: 6px; border-left: 4px solid #16a34a;">
                            <strong>✅ Integração WhatsApp Ativa</strong>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Cadastros (4)</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div class="routine-item" onclick="showRegistrationRoutine('departments')">
                                <div class="routine-icon">🏢</div>
                                <div class="routine-text">
                                    <h4>Departamentos</h4>
                                    <p>Gerencie os departamentos da empresa</p>
                                </div>
                            </div>
                            
                            <div class="routine-item" onclick="showRegistrationRoutine('categories')">
                                <div class="routine-icon">📂</div>
                                <div class="routine-text">
                                    <h4>Categorias de Documentos</h4>
                                    <p>Organize os tipos de documentos</p>
                                </div>
                            </div>
                            
                            <div class="routine-item" onclick="showRegistrationRoutine('positions')">
                                <div class="routine-icon">👔</div>
                                <div class="routine-text">
                                    <h4>Cargos</h4>
                                    <p>Defina os cargos da empresa</p>
                                </div>
                            </div>
                            
                            <div class="routine-item" onclick="showRegistrationRoutine('tags')">
                                <div class="routine-icon">🏷️</div>
                                <div class="routine-text">
                                    <h4>Tags Personalizadas</h4>
                                    <p>Crie tags para classificação</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Registration Routine View -->
                <div id="settings-registration" class="hidden">
                    <div class="section-header">
                        <button class="btn-secondary" onclick="backToSettings()">← Voltar</button>
                        <h2 id="routine-title">Cadastro</h2>
                    </div>
                    
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <button class="btn-primary" onclick="addNewItemInline()">
                                + Novo <span id="new-item-text">Item</span>
                            </button>
                            <input type="text" id="routineSearch" placeholder="Pesquisar por nome..." onkeyup="searchRoutineItems()" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; width: 250px;">
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                        <th style="padding: 1rem; text-align: left; font-weight: 600;">Nome</th>
                                        <th style="padding: 1rem; text-align: left; font-weight: 600;">Data Criação</th>
                                        <th style="padding: 1rem; text-align: center; font-weight: 600;">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="routine-grid-body">
                                    <tr>
                                        <td colspan="3" style="padding: 2rem; text-align: center; color: #6b7280; font-style: italic;">
                                            Carregando dados...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                            <div id="grid-info" style="color: #6b7280; font-size: 0.9rem;">0 resultados</div>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <button class="btn-secondary" onclick="loadMoreItems()">Carregar mais 10 resultados</button>
                                <div style="display: flex; gap: 0.5rem; align-items: center; color: #6b7280; font-size: 0.9rem;">
                                    EXIBIR
                                    <select id="itemsPerPage" onchange="changeItemsPerPage()" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                        <option value="10">10</option>
                                        <option value="25">25</option>
                                        <option value="50">50</option>
                                    </select>
                                    RESULTADOS POR VEZ
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        <!-- Dashboard Unificado com Proatividade Integrada -->
        <div id="dashboard-section" class="section">
            <!-- Header dinâmico com status em tempo real -->
            <div class="section-header">
                <div>
                    <h2>📊 Dashboard Executivo</h2>
                    <p class="text-muted">
                        <span id="lastUpdate">Carregando...</span>
                        <span id="autoRefreshStatus" class="badge badge-sm">Auto-refresh: ON</span>
                    </p>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <select id="dashboard-filter" onchange="filterDashboardData()" class="form-select">
                        <option value="all">Todos</option>
                        <option value="critical">Críticos</option>
                        <option value="pending">Pendentes</option>
                        <option value="today">Hoje</option>
                    </select>
                    <button class="btn-secondary" onclick="loadDashboardData()" id="refreshBtn">
                        <i data-feather="refresh-cw"></i>
                        Atualizar
                    </button>
                    <button class="btn-outline" onclick="toggleAutoRefresh()" id="autoRefreshBtn">
                        <i data-feather="zap"></i>
                    </button>
                </div>
            </div>

            <!-- Cards de métricas principais expandidos -->
            <div class="stats-grid-expanded">
                <div class="stat-card primary" onclick="filterByType('trilhas')" data-tooltip="Ver trilhas ativas">
                    <div class="stat-icon">🎯</div>
                    <div class="stat-value" id="trilhasAtivas">
                        <div class="skeleton" style="width: 60px; height: 32px;"></div>
                    </div>
                    <div class="stat-label">Trilhas Ativas</div>
                    <div class="stat-trend" id="trilhasTrend"></div>
                </div>
                <div class="stat-card info" onclick="filterByType('usuarios')" data-tooltip="Ver usuários em onboarding">
                    <div class="stat-icon">👥</div>
                    <div class="stat-value" id="usuariosOnboarding">
                        <div class="skeleton" style="width: 60px; height: 32px;"></div>
                    </div>
                    <div class="stat-label">Usuários em Onboarding</div>
                    <div class="stat-trend" id="usuariosTrend"></div>
                </div>
                <div class="stat-card success" onclick="filterByType('melhorias')" data-tooltip="Ver melhorias sugeridas">
                    <div class="stat-icon">💡</div>
                    <div class="stat-value" id="melhoriasSugeridas">
                        <div class="skeleton" style="width: 60px; height: 32px;"></div>
                    </div>
                    <div class="stat-label">Melhorias Sugeridas</div>
                    <div class="stat-trend" id="melhoriasTrend"></div>
                </div>
                <div class="stat-card warning" onclick="filterByType('sentimento')" data-tooltip="Ver análise de sentimento">
                    <div class="stat-icon">📈</div>
                    <div class="stat-value" id="sentimentoMedio">
                        <div class="skeleton" style="width: 60px; height: 32px;"></div>
                    </div>
                    <div class="stat-label">Sentimento Médio</div>
                    <div class="stat-trend" id="sentimentoTrend"></div>
                </div>
                <div class="stat-card danger" onclick="filterByType('alertas')" data-tooltip="Ver alertas críticos">
                    <div class="stat-icon">🚨</div>
                    <div class="stat-value" id="alertasAtivos">
                        <div class="skeleton" style="width: 60px; height: 32px;"></div>
                    </div>
                    <div class="stat-label">Alertas Ativos</div>
                    <div class="stat-trend" id="alertasTrend"></div>
                </div>
                <div class="stat-card critical" onclick="filterByType('risco')" data-tooltip="Ver colaboradores em risco">
                    <div class="stat-icon">⚠️</div>
                    <div class="stat-value" id="colaboradoresRisco">
                        <div class="skeleton" style="width: 60px; height: 32px;"></div>
                    </div>
                    <div class="stat-label">Colaboradores em Risco</div>
                    <div class="stat-trend" id="riscoTrend"></div>
                </div>
            </div>

            <!-- Seção de Gráficos Dinâmicos -->
            <div class="charts-section">
                <div class="charts-grid">
                    <!-- Trilhas por Cargo -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>📊 Trilhas por Cargo</h3>
                            <div class="chart-controls">
                                <select id="trilhasCargoFilter" onchange="updateTrilhasCargoChart()" class="form-select-sm">
                                    <option value="ativo">Ativas</option>
                                    <option value="concluido">Concluídas</option>
                                    <option value="atrasado">Atrasadas</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="trilhasCargoChart"></canvas>
                        </div>
                    </div>

                    <!-- Sentimento por Cargo -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>😊 Sentimento por Cargo</h3>
                            <div class="chart-controls">
                                <select id="sentimentoCargoFilter" onchange="updateSentimentoCargoChart()" class="form-select-sm">
                                    <option value="7">Últimos 7 dias</option>
                                    <option value="30">Últimos 30 dias</option>
                                    <option value="90">Últimos 90 dias</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="sentimentoCargoChart"></canvas>
                        </div>
                    </div>

                    <!-- Alertas por Severidade -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>🚨 Alertas por Severidade</h3>
                            <div class="chart-controls">
                                <select id="alertasSeveridadeFilter" onchange="updateAlertasSeveridadeChart()" class="form-select-sm">
                                    <option value="24">Últimas 24h</option>
                                    <option value="7">Últimos 7 dias</option>
                                    <option value="30">Últimos 30 dias</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="alertasSeveridadeChart"></canvas>
                        </div>
                    </div>

                    <!-- Tendência de Engajamento -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>📈 Tendência de Engajamento</h3>
                            <div class="chart-controls">
                                <select id="engajamentoFilter" onchange="updateEngajamentoChart()" class="form-select-sm">
                                    <option value="7">Últimos 7 dias</option>
                                    <option value="30">Últimos 30 dias</option>
                                    <option value="90">Últimos 90 dias</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="engajamentoChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção de Tabelas com Paginação -->
            <div class="tables-section">
                <div class="tables-grid">
                    <!-- Padrões Identificados -->
                    <div class="table-card">
                        <div class="table-header">
                            <h3>🔍 Padrões Identificados</h3>
                            <div class="table-controls">
                                <input type="text" id="padroesSearch" placeholder="Buscar padrões..." class="form-input-sm" onkeyup="searchPadroes()">
                                <button class="btn-sm btn-outline" onclick="exportPadroes()">
                                    <i data-feather="download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Padrão</th>
                                        <th>Tipo</th>
                                        <th>Frequência</th>
                                        <th>Impacto</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="padroesTableBody">
                                    <!-- Carregado dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                        <div class="table-pagination">
                            <button id="padroesPrevBtn" onclick="loadPadroesPage('prev')" disabled>Anterior</button>
                            <span id="padroesPageInfo">Página 1 de 1</span>
                            <button id="padroesNextBtn" onclick="loadPadroesPage('next')" disabled>Próxima</button>
                            <button id="padroesLoadMoreBtn" onclick="loadMorePadroes()" class="btn-outline">Carregar Mais</button>
                        </div>
                    </div>

                    <!-- Alertas Críticos -->
                    <div class="table-card">
                        <div class="table-header">
                            <h3>🚨 Alertas Críticos</h3>
                            <div class="table-controls">
                                <select id="alertasFilter" onchange="filterAlertas()" class="form-select-sm">
                                    <option value="all">Todos</option>
                                    <option value="critica">Críticos</option>
                                    <option value="alta">Altos</option>
                                    <option value="media">Médios</option>
                                </select>
                                <button class="btn-sm btn-outline" onclick="exportAlertas()">
                                    <i data-feather="download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Alerta</th>
                                        <th>Colaborador</th>
                                        <th>Severidade</th>
                                        <th>Data</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="alertasTableBody">
                                    <!-- Carregado dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                        <div class="table-pagination">
                            <button id="alertasPrevBtn" onclick="loadAlertasPage('prev')" disabled>Anterior</button>
                            <span id="alertasPageInfo">Página 1 de 1</span>
                            <button id="alertasNextBtn" onclick="loadAlertasPage('next')" disabled>Próxima</button>
                            <button id="alertasLoadMoreBtn" onclick="loadMoreAlertas()" class="btn-outline">Carregar Mais</button>
                        </div>
                    </div>

                    <!-- Ações Pendentes -->
                    <div class="table-card">
                        <div class="table-header">
                            <h3>⏳ Ações Pendentes</h3>
                            <div class="table-controls">
                                <select id="acoesFilter" onchange="filterAcoes()" class="form-select-sm">
                                    <option value="all">Todas</option>
                                    <option value="pendente">Pendentes</option>
                                    <option value="aprovada">Aprovadas</option>
                                    <option value="rejeitada">Rejeitadas</option>
                                </select>
                                <button class="btn-sm btn-outline" onclick="exportAcoes()">
                                    <i data-feather="download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Ação</th>
                                        <th>Tipo</th>
                                        <th>Colaborador</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="acoesTableBody">
                                    <!-- Carregado dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                        <div class="table-pagination">
                            <button id="acoesPrevBtn" onclick="loadAcoesPage('prev')" disabled>Anterior</button>
                            <span id="acoesPageInfo">Página 1 de 1</span>
                            <button id="acoesNextBtn" onclick="loadAcoesPage('next')" disabled>Próxima</button>
                            <button id="acoesLoadMoreBtn" onclick="loadMoreAcoes()" class="btn-outline">Carregar Mais</button>
                        </div>
                    </div>

                    <!-- Colaboradores em Risco -->
                    <div class="table-card">
                        <div class="table-header">
                            <h3>⚠️ Colaboradores em Risco</h3>
                            <div class="table-controls">
                                <select id="riscoFilter" onchange="filterRisco()" class="form-select-sm">
                                    <option value="all">Todos</option>
                                    <option value="critico">Crítico</option>
                                    <option value="alto">Alto</option>
                                    <option value="medio">Médio</option>
                                </select>
                                <button class="btn-sm btn-outline" onclick="exportRisco()">
                                    <i data-feather="download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Colaborador</th>
                                        <th>Cargo</th>
                                        <th>Score</th>
                                        <th>Fatores</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="riscoTableBody">
                                    <!-- Carregado dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                        <div class="table-pagination">
                            <button id="riscoPrevBtn" onclick="loadRiscoPage('prev')" disabled>Anterior</button>
                            <span id="riscoPageInfo">Página 1 de 1</span>
                            <button id="riscoNextBtn" onclick="loadRiscoPage('next')" disabled>Próxima</button>
                            <button id="riscoLoadMoreBtn" onclick="loadMoreRisco()" class="btn-outline">Carregar Mais</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de detalhes (overlay) -->
            <div id="detailsModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="modalTitle"></h3>
                        <button onclick="closeModal()" class="btn-close">&times;</button>
                    </div>
                    <div class="modal-body" id="modalBody"></div>
                    <div class="modal-footer" id="modalFooter"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = window.location.origin;
        let currentTenant = null;
        let currentUser = null;
        
        // Sidebar toggle functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleIcon = document.getElementById('toggle-icon');
            
            sidebar.classList.toggle('collapsed');
            
            // Update toggle icon
            if (sidebar.classList.contains('collapsed')) {
                toggleIcon.textContent = '→';
            } else {
                toggleIcon.textContent = '←';
            }
            
            // Save preference to localStorage
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        }
        
        // Load sidebar state on page load
        function loadSidebarState() {
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            const sidebar = document.getElementById('sidebar');
            const toggleIcon = document.getElementById('toggle-icon');
            
            if (isCollapsed) {
                sidebar.classList.add('collapsed');
                toggleIcon.textContent = '→';
            }
        }
        
        // Get tenant from URL
        function getTenantFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('tenant') || 'demo';
        }
        
        // Load tenant info
        async function loadTenantInfo() {
            try {
                const tenantSubdomain = getTenantFromUrl();
                console.log('🔍 Buscando tenant:', tenantSubdomain);
                
                const response = await fetch(`${API_BASE}/api/tenants/${tenantSubdomain}`);
                console.log('📡 Resposta da API:', response.status, response.statusText);
                
                if (response.ok) {
                    currentTenant = await response.json();
                    console.log('✅ Tenant carregado:', currentTenant);
                    document.getElementById('tenantName').textContent = currentTenant.name;
                    document.getElementById('tenantSubdomain').textContent = `${currentTenant.subdomain}.flowly.com`;
                } else {
                    console.warn('⚠️ Tenant não encontrado, usando fallback');
                    // Fallback para demo
                    currentTenant = {
                        id: 'demo-id',
                        name: 'Empresa Demo',
                        subdomain: 'demo'
                    };
                    document.getElementById('tenantName').textContent = 'Empresa Demo';
                    document.getElementById('tenantSubdomain').textContent = 'demo.flowly.com';
                }
            } catch (error) {
                console.error('❌ Erro ao carregar tenant:', error);
                // Fallback para demo
                currentTenant = {
                    id: 'demo-id',
                    name: 'Empresa Demo',
                    subdomain: 'demo'
                };
                document.getElementById('tenantName').textContent = 'Empresa Demo';
                document.getElementById('tenantSubdomain').textContent = 'demo.flowly.com';
            }
        }
        
        // Função para detectar seção atual
        function getCurrentSection() {
            const activeSection = document.querySelector('.section.active');
            if (activeSection) {
                return activeSection.id.replace('-section', '');
            }
            return 'insights'; // Default para insights
        }
        
        // Show section - função global para navegação entre seções
        window.showSection = function(section) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('active');
            });
            
            // Update tab buttons (if they exist)
            const tabButtons = document.querySelectorAll('.tab-button');
            if (tabButtons.length > 0) {
                tabButtons.forEach(btn => {
                    btn.classList.remove('active');
                });
                const targetTab = document.getElementById(`${section}-tab`);
                if (targetTab) {
                    targetTab.classList.add('active');
                }
            }
            
            // Show selected section
            const targetSection = document.getElementById(`${section}-section`);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                targetSection.classList.add('active');
            }
            
            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'insights': 'Insights do Navî',
                'users': 'Colaboradores',
                'documents': 'Documentos',
                'settings': 'Configurações'
            };
            const pageTitle = document.getElementById('pageTitle');
            if (pageTitle) {
                pageTitle.textContent = titles[section] || 'Dashboard';
            }
            
            // SEMPRE atualizar dados quando navegar para insights (dashboard)
            if (section === 'insights') {
                console.log('🔄 Navegando para dashboard - atualizando dados...');
                // Usar setTimeout para garantir que a seção seja exibida primeiro
                setTimeout(async () => {
                    await loadDashboardData();
                }, 100);
            }
        }
        
        // Update time
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('pt-BR');
        }
        
        // ===== INSIGHTS FUNCTIONS =====
        let allAnotacoes = [];
        let tenantId = '5978f911-738b-4aae-802a-f037fdac2e64'; // Default tenant
        
        async function loadInsightsData() {
            try {
                const days = document.getElementById('insights-period').value;
                console.log('📊 Carregando insights dos últimos', days, 'dias...');
                
                // Load statistics
                await Promise.all([
                    loadInsightsStats(days),
                    loadPadroes(days),
                    loadAnotacoes(days)
                ]);
                
                console.log('✅ Insights carregados com sucesso!');
                
                // Atualizar Feather Icons após carregar dados
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            } catch (error) {
                console.error('❌ Erro ao carregar insights:', error);
            }
        }
        
        async function loadInsightsStats(days) {
            try {
                // Load anotações
                const anotacoesRes = await fetch(`${API_BASE}/api/agente/anotacoes/${tenantId}?days=${days}`);
                const anotacoesData = await anotacoesRes.json();
                const anotacoes = anotacoesData.anotacoes || anotacoesData;
                
                // Load padrões
                const padroesRes = await fetch(`${API_BASE}/api/agente/anotacoes/padroes/${tenantId}?days=${days}`);
                const padroes = await padroesRes.json();
                
                // Count melhorias (anotações que geraram melhorias)
                const melhorias = anotacoes.filter(a => a.gerou_melhoria).length;
                
                // Calculate average sentiment
                const sentimentos = {
                    muito_positivo: 5,
                    positivo: 4,
                    neutro: 3,
                    negativo: 2,
                    muito_negativo: 1
                };
                
                let totalSentimento = 0;
                let countSentimento = 0;
                anotacoes.forEach(a => {
                    if (a.sentimento && sentimentos[a.sentimento]) {
                        totalSentimento += sentimentos[a.sentimento];
                        countSentimento++;
                    }
                });
                
                const mediaSentimento = countSentimento > 0 ? (totalSentimento / countSentimento).toFixed(1) : '--';
                const emojiSentimento = mediaSentimento >= 4 ? '😊' : mediaSentimento >= 3 ? '😐' : '😔';
                
                // Update stats
                document.getElementById('totalAnotacoes').textContent = anotacoes.length;
                document.getElementById('totalPadroes').textContent = padroes.padroes_por_tipo?.length || 0;
                document.getElementById('totalMelhorias').textContent = melhorias;
                document.getElementById('sentimentoMedio').textContent = mediaSentimento !== '--' ? `${emojiSentimento} ${mediaSentimento}/5` : '--';
                
                // Render charts
                renderChartTipos(padroes.padroes_por_tipo || []);
                renderChartSentimentos(anotacoes);
                
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
                document.getElementById('totalAnotacoes').textContent = '0';
                document.getElementById('totalPadroes').textContent = '0';
                document.getElementById('totalMelhorias').textContent = '0';
                document.getElementById('sentimentoMedio').textContent = '--';
            }
        }
        
        async function loadPadroes(days) {
            try {
                const response = await fetch(`${API_BASE}/api/agente/anotacoes/padroes/${tenantId}?days=${days}`);
                const data = await response.json();
                
                const container = document.getElementById('padroesContainer');
                
                if (!data || (!data.padroes_por_tipo && !data.tags_frequentes && !data.trilhas_problematicas)) {
                    container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 2rem;">Nenhum padrão identificado ainda</p>';
                    return;
                }
                
                let html = '';
                
                // Padrões por tipo
                if (data.padroes_por_tipo && data.padroes_por_tipo.length > 0) {
                    html += '<div style="margin-bottom: 1.5rem;"><h4 style="margin-bottom: 0.5rem;">📋 Por Tipo</h4>';
                    data.padroes_por_tipo.forEach(p => {
                        const tipoLabel = formatTipo(p.tipo);
                        html += `
                            <div style="padding: 0.75rem; background: #f8fafc; border-left: 3px solid #2563eb; margin-bottom: 0.5rem; border-radius: 4px;">
                                <strong>${tipoLabel}</strong>: ${p.total} ocorrências
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                // Tags mais frequentes
                if (data.tags_frequentes && data.tags_frequentes.length > 0) {
                    html += '<div style="margin-bottom: 1.5rem;"><h4 style="margin-bottom: 0.5rem;">🏷️ Tags Mais Frequentes</h4><div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
                    data.tags_frequentes.forEach(tag => {
                        html += `<span style="padding: 0.25rem 0.75rem; background: #dbeafe; color: #1e40af; border-radius: 20px; font-size: 0.9rem;">${tag.tag} (${tag.count})</span>`;
                    });
                    html += '</div></div>';
                }
                
                // Trilhas problemáticas
                if (data.trilhas_problematicas && data.trilhas_problematicas.length > 0) {
                    html += '<div><h4 style="margin-bottom: 0.5rem;">⚠️ Trilhas com Mais Feedbacks Negativos</h4>';
                    data.trilhas_problematicas.forEach(t => {
                        html += `
                            <div style="padding: 0.75rem; background: #fef2f2; border-left: 3px solid #ef4444; margin-bottom: 0.5rem; border-radius: 4px;">
                                <strong>Trilha ID ${t.trilha_id || 'N/A'}</strong>: ${t.total} feedbacks negativos
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                container.innerHTML = html || '<p style="text-align: center; color: #94a3b8; padding: 2rem;">Nenhum padrão identificado</p>';
                
            } catch (error) {
                console.error('Erro ao carregar padrões:', error);
                document.getElementById('padroesContainer').innerHTML = '<p style="text-align: center; color: #ef4444; padding: 2rem;">Erro ao carregar padrões</p>';
            }
        }
        
        async function loadAnotacoes(days) {
            try {
                const response = await fetch(`${API_BASE}/api/agente/anotacoes/${tenantId}?days=${days}`);
                const data = await response.json();
                allAnotacoes = data.anotacoes || data;
                
                renderAnotacoes(allAnotacoes);
                
            } catch (error) {
                console.error('Erro ao carregar anotações:', error);
                document.getElementById('anotacoesContainer').innerHTML = '<p style="text-align: center; color: #ef4444; padding: 2rem;">Erro ao carregar anotações</p>';
            }
        }
        
        function renderAnotacoes(anotacoes) {
            const container = document.getElementById('anotacoesContainer');
            
            if (anotacoes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 2rem;">Nenhuma anotação encontrada</p>';
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
            
            // Show last 20 annotations
            const displayAnotacoes = anotacoes.slice(0, 20);
            
            displayAnotacoes.forEach(a => {
                const tipoLabel = formatTipo(a.tipo);
                const sentimentoEmoji = getSentimentoEmoji(a.sentimento);
                const sentimentoBg = getSentimentoBg(a.sentimento);
                const date = new Date(a.created_at).toLocaleString('pt-BR');
                
                html += `
                    <div style="padding: 1rem; background: white; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <div>
                                <span style="padding: 0.25rem 0.5rem; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 0.85rem; font-weight: 500;">${tipoLabel}</span>
                                ${a.gerou_melhoria ? '<span style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: #dcfce7; color: #166534; border-radius: 4px; font-size: 0.85rem;">💡 Gerou Melhoria</span>' : ''}
                            </div>
                            <span style="padding: 0.25rem 0.5rem; background: ${sentimentoBg}; border-radius: 4px; font-size: 0.85rem;">${sentimentoEmoji} ${formatSentimento(a.sentimento)}</span>
                        </div>
                        <h4 style="margin: 0.5rem 0; color: #1e293b;">${a.titulo || 'Sem título'}</h4>
                        <p style="margin: 0.5rem 0; color: #64748b; font-size: 0.95rem;">${a.anotacao}</p>
                        ${a.tags && a.tags.length > 0 ? `
                            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; margin: 0.5rem 0;">
                                ${a.tags.map(tag => `<span style="padding: 0.15rem 0.5rem; background: #f1f5f9; color: #475569; border-radius: 12px; font-size: 0.8rem;">#${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #f1f5f9; font-size: 0.85rem; color: #94a3b8;">
                            <span>👤 ${a.colaborador_nome || 'N/A'}</span>
                            <span>🕒 ${date}</span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (anotacoes.length > 20) {
                html += `<p style="text-align: center; color: #64748b; margin-top: 1rem;">Mostrando 20 de ${anotacoes.length} anotações</p>`;
            }
            
            container.innerHTML = html;
        }
        
        function filtrarAnotacoes() {
            const tipo = document.getElementById('filtroTipo').value;
            const sentimento = document.getElementById('filtroSentimento').value;
            
            let filtered = allAnotacoes;
            
            if (tipo) {
                filtered = filtered.filter(a => a.tipo === tipo);
            }
            
            if (sentimento) {
                filtered = filtered.filter(a => a.sentimento === sentimento);
            }
            
            renderAnotacoes(filtered);
        }
        
        function renderChartTipos(padroesTipo) {
            const container = document.getElementById('chartTipos');
            
            if (!padroesTipo || padroesTipo.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 2rem;">Sem dados</p>';
                return;
            }
            
            const maxValue = Math.max(...padroesTipo.map(p => p.total));
            
            let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
            
            padroesTipo.forEach(p => {
                const percentage = (p.total / maxValue) * 100;
                const tipoLabel = formatTipo(p.tipo);
                
                html += `
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span style="font-size: 0.9rem; color: #475569;">${tipoLabel}</span>
                            <span style="font-size: 0.9rem; font-weight: 600; color: #1e293b;">${p.total}</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, #2563eb, #1d4ed8); transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function renderChartSentimentos(anotacoes) {
            const container = document.getElementById('chartSentimentos');
            
            if (!anotacoes || anotacoes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 2rem;">Sem dados</p>';
                return;
            }
            
            // Count sentimentos
            const counts = {
                muito_positivo: 0,
                positivo: 0,
                neutro: 0,
                negativo: 0,
                muito_negativo: 0
            };
            
            anotacoes.forEach(a => {
                if (a.sentimento && counts.hasOwnProperty(a.sentimento)) {
                    counts[a.sentimento]++;
                }
            });
            
            const sentimentos = [
                { label: 'Muito Positivo', value: counts.muito_positivo, emoji: '😍', color: '#10b981' },
                { label: 'Positivo', value: counts.positivo, emoji: '😊', color: '#3b82f6' },
                { label: 'Neutro', value: counts.neutro, emoji: '😐', color: '#6b7280' },
                { label: 'Negativo', value: counts.negativo, emoji: '😔', color: '#f59e0b' },
                { label: 'Muito Negativo', value: counts.muito_negativo, emoji: '😡', color: '#ef4444' }
            ];
            
            const maxValue = Math.max(...sentimentos.map(s => s.value));
            
            let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
            
            sentimentos.forEach(s => {
                if (s.value === 0) return; // Skip zero values
                
                const percentage = maxValue > 0 ? (s.value / maxValue) * 100 : 0;
                
                html += `
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span style="font-size: 0.9rem; color: #475569;">${s.emoji} ${s.label}</span>
                            <span style="font-size: 0.9rem; font-weight: 600; color: #1e293b;">${s.value}</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: ${s.color}; transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function formatTipo(tipo) {
            const tipos = {
                duvida_frequente: '❓ Dúvida Frequente',
                dificuldade_trilha: '🚧 Dificuldade na Trilha',
                feedback_positivo: '👍 Feedback Positivo',
                feedback_negativo: '👎 Feedback Negativo',
                sugestao_melhoria: '💡 Sugestão de Melhoria',
                observacao_geral: '📝 Observação Geral'
            };
            return tipos[tipo] || tipo;
        }
        
        function formatSentimento(sentimento) {
            const sentimentos = {
                muito_positivo: 'Muito Positivo',
                positivo: 'Positivo',
                neutro: 'Neutro',
                negativo: 'Negativo',
                muito_negativo: 'Muito Negativo'
            };
            return sentimentos[sentimento] || sentimento || 'N/A';
        }
        
        function getSentimentoEmoji(sentimento) {
            const emojis = {
                muito_positivo: '😍',
                positivo: '😊',
                neutro: '😐',
                negativo: '😔',
                muito_negativo: '😡'
            };
            return emojis[sentimento] || '😐';
        }
        
        function getSentimentoBg(sentimento) {
            const colors = {
                muito_positivo: '#dcfce7',
                positivo: '#dbeafe',
                neutro: '#f3f4f6',
                negativo: '#fef3c7',
                muito_negativo: '#fee2e2'
            };
            return colors[sentimento] || '#f3f4f6';
        }
        // ===== END INSIGHTS FUNCTIONS =====
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('🚀 Iniciando carregamento do dashboard...');
                
                console.log('📱 Carregando estado da sidebar...');
                loadSidebarState();
                
                console.log('🏢 Carregando informações do tenant...');
                await loadTenantInfo();
                
                console.log('🔄 Inicializando auto-refresh automático...');
                initializeAutoRefresh();
                
                console.log('⏰ Atualizando relógio...');
                updateTime();
                setInterval(updateTime, 1000);
                
                // Carregar dados do dashboard se estiver na seção insights
                const currentSection = getCurrentSection();
                if (currentSection === 'insights') {
                    console.log('📊 Carregando dados do dashboard inicial...');
                    await loadDashboardData();
                }
                
                console.log('✅ Dashboard carregado com sucesso!');
            } catch (error) {
                console.error('❌ Erro ao carregar dashboard:', error);
            }
        });
        
    </script>
    
    <!-- ===== FUNÇÕES DO DASHBOARD UNIFICADO (ESCOPO GLOBAL) ===== -->
    <script>
        // Variáveis globais para o dashboard unificado
        let dashboardData = {
            metrics: {},
            charts: {},
            tables: {
                padroes: { data: [], page: 1, totalPages: 1 },
                alertas: { data: [], page: 1, totalPages: 1 },
                acoes: { data: [], page: 1, totalPages: 1 },
                risco: { data: [], page: 1, totalPages: 1 }
            }
        };
        
        let autoRefreshInterval = null;
        let autoRefreshEnabled = true; // Sempre ativo
        let lastRefreshTime = null;
        
        // Carregar dados do dashboard unificado
        async function loadDashboardData() {
            try {
                console.log('🔄 Carregando dados do dashboard unificado...');
                
                // Atualizar timestamp
                const lastUpdateEl = document.getElementById('lastUpdate');
                if (lastUpdateEl) {
                    lastUpdateEl.textContent = `Última atualização: ${new Date().toLocaleTimeString()}`;
                }
                
                // Carregar métricas principais
                await loadDashboardMetrics();
                
                // Carregar gráficos
                await loadDashboardCharts();
                
                // Carregar tabelas
                await loadDashboardTables();
                
                lastRefreshTime = new Date();
                console.log('✅ Dashboard unificado carregado com sucesso!');
            } catch (error) {
                console.error('❌ Erro ao carregar dashboard unificado:', error);
            }
        }
        
        // Carregar métricas principais
        async function loadDashboardMetrics() {
            try {
                console.log('📊 Carregando métricas do banco...');
                
                // Buscar dados do banco usando a função otimizada
                const tenantId = '5978f911-738b-4aae-802a-f037fdac2e64'; // Tenant demo
                const response = await fetch(`/api/dashboard/metrics/${tenantId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Atualizar cards de métricas com dados reais
                    updateMetricCard('trilhasAtivas', data.trilhasAtivas || 0, data.trilhasTrend || '+0%');
                    updateMetricCard('usuariosOnboarding', data.usuariosOnboarding || 0, data.usuariosTrend || '+0%');
                    updateMetricCard('melhoriasSugeridas', data.melhoriasSugeridas || 0, data.melhoriasTrend || '+0%');
                    updateMetricCard('sentimentoMedio', data.sentimentoMedio ? parseFloat(data.sentimentoMedio).toFixed(1) : '--', data.sentimentoTrend || '+0%');
                    updateMetricCard('alertasAtivos', data.alertasAtivos || 0, data.alertasTrend || '+0%');
                    updateMetricCard('colaboradoresRisco', data.colaboradoresRisco || 0, data.riscoTrend || '+0%');
                    
                    console.log('✅ Métricas carregadas do banco com sucesso!');
                } else {
                    throw new Error('Erro ao buscar métricas do banco');
                }
                
            } catch (error) {
                console.error('❌ Erro ao carregar métricas:', error);
                console.log('📊 Usando dados mock como fallback...');
                
                // Fallback com dados mock
                updateMetricCard('trilhasAtivas', 12, '+15%');
                updateMetricCard('usuariosOnboarding', 8, '+8%');
                updateMetricCard('melhoriasSugeridas', 5, '+12%');
                updateMetricCard('sentimentoMedio', '4.2', '+0.3');
                updateMetricCard('alertasAtivos', 3, '-25%');
                updateMetricCard('colaboradoresRisco', 2, '-50%');
            }
        }
        
        // Atualizar card de métrica
        function updateMetricCard(elementId, value, trend) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = value;
                
                const trendElement = document.getElementById(elementId.replace('Ativas', 'Trend').replace('Onboarding', 'Trend').replace('Sugeridas', 'Trend').replace('Medio', 'Trend').replace('Ativos', 'Trend').replace('Risco', 'Trend'));
                if (trendElement) {
                    trendElement.textContent = trend;
                    trendElement.className = `stat-trend ${trend.startsWith('+') ? 'positive' : trend.startsWith('-') ? 'negative' : 'neutral'}`;
                }
            }
        }
        
        // Carregar gráficos do dashboard
        async function loadDashboardCharts() {
            try {
                console.log('📊 Carregando dados dos gráficos do banco...');
                
                // Buscar dados reais do banco
                const tenantId = '5978f911-738b-4aae-802a-f037fdac2e64';
                const response = await fetch(`/api/dashboard/metrics/${tenantId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('📊 Dados dos gráficos carregados:', data.graficos);
                    
                    // Trilhas por Cargo (dados reais)
                    await updateTrilhasCargoChart(data.graficos?.trilhasPorCargo);
                    
                    // Sentimento por Cargo (dados reais)
                    await updateSentimentoCargoChart(data.graficos?.sentimentoPorCargo);
                    
                    // Alertas por Severidade (dados reais)
                    await updateAlertasSeveridadeChart(data.graficos?.alertasPorSeveridade);
                    
                    // Tendência de Engajamento (dados reais)
                    await updateEngajamentoChart(data.graficos?.tendenciaEngajamento);
                    
                } else {
                    throw new Error('Erro ao buscar dados dos gráficos');
                }
                
            } catch (error) {
                console.error('❌ Erro ao carregar gráficos:', error);
                console.log('📊 Usando dados mock como fallback...');
                
                // Fallback com dados mock
                await updateTrilhasCargoChart();
                await updateSentimentoCargoChart();
                await updateAlertasSeveridadeChart();
                await updateEngajamentoChart();
            }
        }
        
        // Atualizar gráfico de Trilhas por Cargo
        async function updateTrilhasCargoChart(realData = null) {
            const canvas = document.getElementById('trilhasCargoChart');
            if (!canvas) return;
            
            // Verificar se Chart.js está disponível
            if (typeof Chart === 'undefined') {
                console.warn('⚠️ Chart.js não está carregado ainda');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            const filter = document.getElementById('trilhasCargoFilter')?.value || 'ativo';
            
            let chartData;
            
            if (realData && realData.length > 0) {
                // Usar dados reais do banco
                chartData = {
                    labels: realData.map(item => item.cargo),
                    datasets: [{
                        label: filter === 'ativo' ? 'Trilhas Ativas' : filter === 'concluido' ? 'Concluídas' : 'Atrasadas',
                        data: realData.map(item => {
                            if (filter === 'ativo') return item.ativas;
                            if (filter === 'concluido') return item.concluidas;
                            return item.atrasadas;
                        }),
                        backgroundColor: filter === 'ativo' ? '#3b82f6' : filter === 'concluido' ? '#10b981' : '#ef4444',
                        borderColor: filter === 'ativo' ? '#2563eb' : filter === 'concluido' ? '#059669' : '#dc2626',
                        borderWidth: 1
                    }]
                };
            } else {
                // Dados mock para demonstração
                chartData = {
                    labels: ['Desenvolvedor', 'Designer', 'Product Manager', 'QA', 'DevOps'],
                    datasets: [{
                        label: filter === 'ativo' ? 'Trilhas Ativas' : filter === 'concluido' ? 'Concluídas' : 'Atrasadas',
                        data: filter === 'ativo' ? [8, 6, 4, 5, 3] : filter === 'concluido' ? [12, 8, 6, 7, 4] : [2, 1, 1, 2, 1],
                        backgroundColor: filter === 'ativo' ? '#3b82f6' : filter === 'concluido' ? '#10b981' : '#ef4444',
                        borderColor: filter === 'ativo' ? '#2563eb' : filter === 'concluido' ? '#059669' : '#dc2626',
                        borderWidth: 1
                    }]
                };
            }
            
            // Destruir gráfico existente se houver
            if (window.trilhasCargoChart && typeof window.trilhasCargoChart.destroy === 'function') {
                window.trilhasCargoChart.destroy();
            }
            
            window.trilhasCargoChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Atualizar gráfico de Sentimento por Cargo
        async function updateSentimentoCargoChart(realData = null) {
            const canvas = document.getElementById('sentimentoCargoChart');
            if (!canvas) return;
            
            // Verificar se Chart.js está disponível
            if (typeof Chart === 'undefined') {
                console.warn('⚠️ Chart.js não está carregado ainda');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            let chartData;
            
            if (realData && realData.length > 0) {
                // Usar dados reais do banco
                chartData = {
                    labels: realData.map(item => item.cargo),
                    datasets: [{
                        label: 'Sentimento Médio',
                        data: realData.map(item => parseFloat(item.sentimento).toFixed(1)),
                        backgroundColor: '#10b981',
                        borderColor: '#059669',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                };
            } else {
                // Dados mock para demonstração
                chartData = {
                    labels: ['Desenvolvedor', 'Designer', 'Product Manager', 'QA', 'DevOps'],
                    datasets: [{
                        label: 'Sentimento Médio',
                        data: [4.2, 4.5, 4.1, 3.8, 4.3],
                        backgroundColor: '#10b981',
                        borderColor: '#059669',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                };
            }
            
            if (window.sentimentoCargoChart && typeof window.sentimentoCargoChart.destroy === 'function') {
                window.sentimentoCargoChart.destroy();
            }
            
            window.sentimentoCargoChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: 5
                        }
                    }
                }
            });
        }
        
        // Atualizar gráfico de Alertas por Severidade
        async function updateAlertasSeveridadeChart() {
            const canvas = document.getElementById('alertasSeveridadeChart');
            if (!canvas) return;
            
            // Verificar se Chart.js está disponível
            if (typeof Chart === 'undefined') {
                console.warn('⚠️ Chart.js não está carregado ainda');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // Dados mock para demonstração
            const data = {
                labels: ['Crítico', 'Alto', 'Médio', 'Baixo'],
                datasets: [{
                    data: [2, 5, 8, 12],
                    backgroundColor: ['#dc2626', '#f59e0b', '#3b82f6', '#10b981'],
                    borderWidth: 0
                }]
            };
            
            if (window.alertasSeveridadeChart && typeof window.alertasSeveridadeChart.destroy === 'function') {
                window.alertasSeveridadeChart.destroy();
            }
            
            window.alertasSeveridadeChart = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Atualizar gráfico de Tendência de Engajamento
        async function updateEngajamentoChart() {
            const canvas = document.getElementById('engajamentoChart');
            if (!canvas) return;
            
            // Verificar se Chart.js está disponível
            if (typeof Chart === 'undefined') {
                console.warn('⚠️ Chart.js não está carregado ainda');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // Dados mock para demonstração
            const data = {
                labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'],
                datasets: [{
                    label: 'Engajamento',
                    data: [85, 78, 92, 88, 95, 82, 89],
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderColor: '#3b82f6',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.1
                }]
            };
            
            if (window.engajamentoChart && typeof window.engajamentoChart.destroy === 'function') {
                window.engajamentoChart.destroy();
            }
            
            window.engajamentoChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }
        
        // Carregar tabelas do dashboard
        async function loadDashboardTables() {
            try {
                await loadPadroesTable();
                await loadAlertasTable();
                await loadAcoesTable();
                await loadRiscoTable();
            } catch (error) {
                console.error('❌ Erro ao carregar tabelas:', error);
            }
        }
        
        // Carregar tabela de Padrões
        async function loadPadroesTable() {
            const tbody = document.getElementById('padroesTableBody');
            if (!tbody) return;
            
            // Dados mock para demonstração
            const padroes = [
                { padrao: 'Dificuldade com documentação técnica', tipo: 'Dificuldade', frequencia: 'Alta', impacto: 'Médio' },
                { padrao: 'Feedback positivo sobre onboarding', tipo: 'Positivo', frequencia: 'Média', impacto: 'Baixo' },
                { padrao: 'Sugestões de melhoria em trilhas', tipo: 'Sugestão', frequencia: 'Alta', impacto: 'Alto' }
            ];
            
            tbody.innerHTML = padroes.map(p => `
                <tr>
                    <td>${p.padrao}</td>
                    <td><span class="badge badge-sm">${p.tipo}</span></td>
                    <td>${p.frequencia}</td>
                    <td>${p.impacto}</td>
                    <td>
                        <button class="btn-sm btn-outline" onclick="viewPadraoDetails('${p.padrao}')">
                            <i data-feather="eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            feather.replace();
        }
        
        // Carregar tabela de Alertas
        async function loadAlertasTable() {
            const tbody = document.getElementById('alertasTableBody');
            if (!tbody) return;
            
            // Dados mock para demonstração
            const alertas = [
                { alerta: 'Baixo engajamento em trilha', colaborador: 'João Silva', severidade: 'Alta', data: '2024-12-20' },
                { alerta: 'Múltiplas dúvidas não resolvidas', colaborador: 'Maria Santos', severidade: 'Média', data: '2024-12-19' }
            ];
            
            tbody.innerHTML = alertas.map(a => `
                <tr>
                    <td>${a.alerta}</td>
                    <td>${a.colaborador}</td>
                    <td><span class="badge badge-sm ${a.severidade.toLowerCase()}">${a.severidade}</span></td>
                    <td>${a.data}</td>
                    <td>
                        <button class="btn-sm btn-primary" onclick="resolveAlert('${a.alerta}')">
                            <i data-feather="check"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            feather.replace();
        }
        
        // Carregar tabela de Ações
        async function loadAcoesTable() {
            const tbody = document.getElementById('acoesTableBody');
            if (!tbody) return;
            
            // Dados mock para demonstração
            const acoes = [
                { acao: 'Revisar trilha de onboarding', tipo: 'Melhoria', colaborador: 'Sistema', status: 'Pendente' },
                { acao: 'Agendar reunião de feedback', tipo: 'Ação', colaborador: 'João Silva', status: 'Aprovada' }
            ];
            
            tbody.innerHTML = acoes.map(a => `
                <tr>
                    <td>${a.acao}</td>
                    <td>${a.tipo}</td>
                    <td>${a.colaborador}</td>
                    <td><span class="badge badge-sm ${a.status.toLowerCase()}">${a.status}</span></td>
                    <td>
                        <button class="btn-sm btn-success" onclick="approveAction('${a.acao}')">
                            <i data-feather="check"></i>
                        </button>
                        <button class="btn-sm btn-danger" onclick="rejectAction('${a.acao}')">
                            <i data-feather="x"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            feather.replace();
        }
        
        // Carregar tabela de Risco
        async function loadRiscoTable() {
            const tbody = document.getElementById('riscoTableBody');
            if (!tbody) return;
            
            // Dados mock para demonstração
            const riscos = [
                { colaborador: 'João Silva', cargo: 'Desenvolvedor', score: 75, fatores: 'Baixo engajamento, múltiplas dúvidas' },
                { colaborador: 'Maria Santos', cargo: 'Designer', score: 60, fatores: 'Dificuldade com ferramentas' }
            ];
            
            tbody.innerHTML = riscos.map(r => `
                <tr>
                    <td>${r.colaborador}</td>
                    <td>${r.cargo}</td>
                    <td><span class="badge badge-sm ${r.score > 70 ? 'danger' : r.score > 50 ? 'warning' : 'success'}">${r.score}</span></td>
                    <td>${r.fatores}</td>
                    <td>
                        <button class="btn-sm btn-primary" onclick="viewRiskDetails('${r.colaborador}')">
                            <i data-feather="eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            feather.replace();
        }
        
        // Funções de filtro e paginação
        function filterDashboardData() {
            const filter = document.getElementById('dashboard-filter').value;
            console.log('🔍 Filtrando dashboard por:', filter);
            loadDashboardData();
        }
        
        function filterByType(type) {
            console.log('🎯 Filtrando por tipo:', type);
            // Implementar filtro específico por tipo
        }
        
        // Inicializar auto-refresh automático (5 minutos)
        function initializeAutoRefresh() {
            // Parar qualquer intervalo existente
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // Configurar auto-refresh para 5 minutos (300000ms)
            autoRefreshInterval = setInterval(() => {
                console.log('⏰ Auto-refresh executando...');
                loadDashboardData();
            }, 300000); // 5 minutos
            
            console.log('🔄 Auto-refresh configurado para 5 minutos');
        }
        
        // Função para refresh manual (botão único)
        function manualRefresh() {
            console.log('🔄 Refresh manual solicitado...');
            loadDashboardData();
        }
        
        // Parar auto-refresh (se necessário)
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('⏹️ Auto-refresh parado');
            }
        }
        
        // Mostrar alerta crítico recebido via Realtime
        function showCriticalAlert(notification) {
            console.log('🚨 Exibindo alerta crítico:', notification);
            
            // Criar elemento de notificação no chat flutuante
            if (window.chatWidget && notification.colaborador_nome) {
                const alertMessage = `
🚨 **ALERTA CRÍTICO DETECTADO**

👤 **Colaborador:** ${notification.colaborador_nome}
⚠️ **Problema:** ${notification.problema || 'Não especificado'}
🔴 **Urgência:** ${notification.urgencia}
📂 **Categoria:** ${notification.categoria}

💡 **Ação Sugerida:** ${notification.acao_sugerida || 'Verificar anotação'}

⏰ **Detectado em:** ${new Date(notification.created_at).toLocaleString('pt-BR')}

---
*Este alerta foi gerado automaticamente pelo sistema de detecção de urgência.*
                `;
                
                // Enviar mensagem para o chat widget
                if (window.chatWidget.addSystemMessage) {
                    window.chatWidget.addSystemMessage(alertMessage);
                }
            }
            
            // Atualizar contador de alertas
            const alertasBadge = document.getElementById('alertasAtivos');
            if (alertasBadge) {
                const currentCount = parseInt(alertasBadge.textContent.replace(/\D/g, '')) || 0;
                alertasBadge.textContent = currentCount + 1;
            }
        }
        
        // Funções de paginação (implementação básica)
        function loadPadroesPage(direction) {
            console.log('📄 Carregando página de padrões:', direction);
            // Implementar paginação
        }
        
        function loadMorePadroes() {
            console.log('📄 Carregando mais padrões...');
            // Implementar carregar mais
        }
        
        function loadAlertasPage(direction) {
            console.log('📄 Carregando página de alertas:', direction);
            // Implementar paginação
        }
        
        function loadMoreAlertas() {
            console.log('📄 Carregando mais alertas...');
            // Implementar carregar mais
        }
        
        function loadAcoesPage(direction) {
            console.log('📄 Carregando página de ações:', direction);
            // Implementar paginação
        }
        
        function loadMoreAcoes() {
            console.log('📄 Carregando mais ações...');
            // Implementar carregar mais
        }
        
        function loadRiscoPage(direction) {
            console.log('📄 Carregando página de risco:', direction);
            // Implementar paginação
        }
        
        function loadMoreRisco() {
            console.log('📄 Carregando mais riscos...');
            // Implementar carregar mais
        }
        
        // Funções de ação
        function viewPadraoDetails(padrao) {
            console.log('👁️ Visualizando detalhes do padrão:', padrao);
            showModal('Detalhes do Padrão', `Padrão: ${padrao}<br>Detalhes completos aqui...`);
        }
        
        function resolveAlert(alerta) {
            console.log('✅ Resolvendo alerta:', alerta);
            // Implementar resolução de alerta
        }
        
        function approveAction(acao) {
            console.log('✅ Aprovando ação:', acao);
            // Implementar aprovação de ação
        }
        
        function rejectAction(acao) {
            console.log('❌ Rejeitando ação:', acao);
            // Implementar rejeição de ação
        }
        
        function viewRiskDetails(colaborador) {
            console.log('👁️ Visualizando detalhes de risco:', colaborador);
            showModal('Detalhes de Risco', `Colaborador: ${colaborador}<br>Análise completa de risco aqui...`);
        }
        
        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('detailsModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }
        
        // Funções de exportação
        function exportPadroes() {
            console.log('📤 Exportando padrões...');
            // Implementar exportação
        }
        
        function exportAlertas() {
            console.log('📤 Exportando alertas...');
            // Implementar exportação
        }
        
        function exportAcoes() {
            console.log('📤 Exportando ações...');
            // Implementar exportação
        }
        
        function exportRisco() {
            console.log('📤 Exportando riscos...');
            // Implementar exportação
        }
        
        // Funções de busca
        function searchPadroes() {
            const search = document.getElementById('padroesSearch').value;
            console.log('🔍 Buscando padrões:', search);
            // Implementar busca
        }
        
        function filterAlertas() {
            const filter = document.getElementById('alertasFilter').value;
            console.log('🔍 Filtrando alertas:', filter);
            // Implementar filtro
        }
        
        function filterAcoes() {
            const filter = document.getElementById('acoesFilter').value;
            console.log('🔍 Filtrando ações:', filter);
            // Implementar filtro
        }
        
        function filterRisco() {
            const filter = document.getElementById('riscoFilter').value;
            console.log('🔍 Filtrando riscos:', filter);
            // Implementar filtro
        }
        
        // ===== FIM DAS FUNÇÕES DO DASHBOARD UNIFICADO =====
    </script>
    
    <script>
        let currentRoutine = null;
        let editingItemId = null;
        
        function showRegistrationRoutine(routine) {
            currentRoutine = routine;
            
            // Hide main settings, show registration view
            document.getElementById('settings-main').classList.add('hidden');
            document.getElementById('settings-registration').classList.remove('hidden');
            
            // Update title and button text
            const titles = {
                departments: 'Departamentos',
                categories: 'Categorias de Documentos',
                positions: 'Cargos',
                tags: 'Tags Personalizadas'
            };
            
            const buttonTexts = {
                departments: 'Departamento',
                categories: 'Categoria',
                positions: 'Cargo',
                tags: 'Tag'
            };
            
            document.getElementById('routine-title').textContent = titles[routine];
            document.getElementById('new-item-text').textContent = buttonTexts[routine];
            
            // Load routine data
            loadRoutineData();
        }
        
        function backToSettings() {
            document.getElementById('settings-main').classList.remove('hidden');
            document.getElementById('settings-registration').classList.add('hidden');
            currentRoutine = null;
            editingItemId = null;
        }
        
        async function loadRoutineData() {
            if (!currentRoutine) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/${currentRoutine}?tenant=${getTenantFromUrl()}`);
                if (response.ok) {
                    const data = await response.json();
                    displayRoutineData(data);
                } else {
                    console.error('Erro ao carregar dados:', response.statusText);
                    displayRoutineData([]);
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                displayRoutineData([]);
            }
        }
        
        function displayRoutineData(items) {
            const tbody = document.getElementById('routine-grid-body');
            
            if (items.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" style="padding: 2rem; text-align: center; color: #6b7280; font-style: italic;">
                            Nenhum ${getRoutineName()} encontrado
                        </td>
                    </tr>
                `;
                document.getElementById('grid-info').textContent = '0 resultados';
                return;
            }
            
            tbody.innerHTML = items.map(item => `
                <tr>
                    <td style="padding: 1rem; font-weight: 500;">${item.name}</td>
                    <td style="padding: 1rem; color: #6b7280;">${new Date(item.created_at).toLocaleDateString('pt-BR')}</td>
                    <td style="padding: 1rem; text-align: center;">
                        <button class="btn-edit" onclick="editItemInline('${item.id}', '${item.name.replace(/'/g, "\\'")}')">✏️ Editar</button>
                        <button class="btn-delete" onclick="deleteItem('${item.id}', '${item.name.replace(/'/g, "\\'")}')">🗑️ Excluir</button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('grid-info').textContent = `${items.length} resultado(s)`;
        }
        
        function getRoutineName() {
            const names = {
                departments: 'departamento',
                categories: 'categoria',
                positions: 'cargo',
                tags: 'tag'
            };
            return names[currentRoutine] || 'item';
        }
        
        function addNewItemInline() {
            if (editingItemId) {
                cancelInlineEdit();
            }
            
            const tbody = document.getElementById('routine-grid-body');
            const newRow = document.createElement('tr');
            newRow.className = 'inline-row';
            newRow.innerHTML = `
                <td style="padding: 1rem;">
                    <input type="text" id="inlineName" placeholder="Nome do ${getRoutineName()}" style="width: 100%;">
                </td>
                <td style="padding: 1rem; color: #6b7280;">-</td>
                <td style="padding: 1rem; text-align: center;">
                    <div class="inline-actions">
                        <button class="btn-inline-save" onclick="saveInlineItem()">✅ Salvar</button>
                        <button class="btn-inline-cancel" onclick="cancelInlineEdit()">❌ Cancelar</button>
                    </div>
                </td>
            `;
            
            tbody.insertBefore(newRow, tbody.firstChild);
            
            // Focus on input and add keyboard listeners
            const input = document.getElementById('inlineName');
            input.focus();
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveInlineItem();
                } else if (e.key === 'Escape') {
                    cancelInlineEdit();
                }
            });
        }
        
        function editItemInline(id, currentName) {
            if (editingItemId) {
                cancelInlineEdit();
            }
            
            editingItemId = id;
            
            // Find the row with this ID
            const rows = document.querySelectorAll('#routine-grid-body tr');
            let targetRow = null;
            
            for (let row of rows) {
                const editButton = row.querySelector('.btn-edit');
                if (editButton && editButton.onclick.toString().includes(id)) {
                    targetRow = row;
                    break;
                }
            }
            
            if (!targetRow) return;
            
            targetRow.className = 'inline-row';
            targetRow.innerHTML = `
                <td style="padding: 1rem;">
                    <input type="text" id="inlineName" value="${currentName.replace(/"/g, '&quot;')}" style="width: 100%;">
                </td>
                <td style="padding: 1rem; color: #6b7280;">-</td>
                <td style="padding: 1rem; text-align: center;">
                    <div class="inline-actions">
                        <button class="btn-inline-save" onclick="saveInlineItem()">✅ Salvar</button>
                        <button class="btn-inline-cancel" onclick="cancelInlineEdit()">❌ Cancelar</button>
                    </div>
                </td>
            `;
            
            // Focus on input and select all text
            const input = document.getElementById('inlineName');
            input.focus();
            input.select();
            
            // Add keyboard listeners
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveInlineItem();
                } else if (e.key === 'Escape') {
                    cancelInlineEdit();
                }
            });
        }
        
        async function saveInlineItem() {
            const nameInput = document.getElementById('inlineName');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Por favor, informe o nome.');
                return;
            }
            
            try {
                let response;
                
                if (editingItemId) {
                    // Update existing item
                    response = await fetch(`${API_BASE}/api/${currentRoutine}/${editingItemId}?tenant=${getTenantFromUrl()}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ name }),
                    });
                } else {
                    // Create new item
                    response = await fetch(`${API_BASE}/api/${currentRoutine}?tenant=${getTenantFromUrl()}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ name }),
                    });
                }
                
                if (response.ok) {
                    editingItemId = null;
                    loadRoutineData(); // Reload data
                } else {
                    const error = await response.json();
                    alert(`Erro: ${error.message || 'Erro desconhecido'}`);
                }
            } catch (error) {
                console.error('Erro ao salvar:', error);
                alert('Erro ao salvar. Tente novamente.');
            }
        }
        
        function cancelInlineEdit() {
            editingItemId = null;
            loadRoutineData(); // Reload to restore original state
        }
        
        async function deleteItem(id, name) {
            if (!confirm(`Tem certeza que deseja excluir "${name}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/${currentRoutine}/${id}?tenant=${getTenantFromUrl()}`, {
                    method: 'DELETE',
                });
                
                if (response.ok) {
                    loadRoutineData(); // Reload data
                } else {
                    const error = await response.json();
                    alert(`Erro: ${error.message || 'Erro desconhecido'}`);
                }
            } catch (error) {
                console.error('Erro ao excluir:', error);
                alert('Erro ao excluir. Tente novamente.');
            }
        }
        
        function searchRoutineItems() {
            const searchTerm = document.getElementById('routineSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#routine-grid-body tr');
            
            rows.forEach(row => {
                const nameCell = row.querySelector('td:first-child');
                if (nameCell) {
                    const name = nameCell.textContent.toLowerCase();
                    if (name.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        }
        
        function loadMoreItems() {
            // Placeholder for pagination
            console.log('Carregar mais itens...');
        }
        
        function changeItemsPerPage() {
            // Placeholder for items per page
            console.log('Alterar itens por página...');
        }

    // ===== SISTEMA DE NOTIFICAÇÕES =====
    
    let notificationInterval = null;
    let proactiveData = {
        alerts: [],
        actions: [],
        risks: [],
        insights: []
    };

    // Toggle dropdown de notificações
    function toggleNotifications() {
        const dropdown = document.getElementById('notificationDropdown');
        const isVisible = dropdown.style.display !== 'none';
        
        if (isVisible) {
            dropdown.style.display = 'none';
        } else {
            dropdown.style.display = 'block';
            loadNotifications();
        }
    }

    // Carregar notificações
    async function loadNotifications() {
        try {
            if (!currentUser) return;
            
            const response = await fetch(`${API_BASE}/api/notifications/unread/${currentUser.id}`);
            const data = await response.json();
            
            if (data.success) {
                renderNotifications(data.notifications);
                updateNotificationBadge(data.count);
            }
        } catch (error) {
            console.error('❌ Erro ao carregar notificações:', error);
        }
    }

    // Renderizar notificações
    function renderNotifications(notifications) {
        const container = document.getElementById('notificationList');
        
        if (notifications.length === 0) {
            container.innerHTML = '<div style="padding: 20px; text-align: center; color: #6b7280;">Nenhuma notificação</div>';
            return;
        }

        container.innerHTML = notifications.map(notif => `
            <div class="notification-item ${notif.lida ? '' : 'unread'}" onclick="handleNotificationClick('${notif.id}')">
                <div style="display: flex; align-items: start; gap: 12px;">
                    <div style="color: ${notif.tipo_info.color}; font-size: 16px;">${notif.tipo_info.icon}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 500; font-size: 14px; margin-bottom: 4px;">${notif.titulo}</div>
                        <div style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">${notif.mensagem}</div>
                        <div style="font-size: 12px; color: #9ca3af;">${formatTimeAgo(notif.created_at)}</div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Atualizar badge de notificações
    function updateNotificationBadge(count) {
        const badge = document.getElementById('notificationBadge');
        if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'block';
        } else {
            badge.style.display = 'none';
        }
    }

    // Marcar notificação como lida
    async function handleNotificationClick(notificationId) {
        try {
            const response = await fetch(`${API_BASE}/api/notifications/${notificationId}/read`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: currentUser.id })
            });
            
            if (response.ok) {
                loadNotifications(); // Recarregar notificações
            }
        } catch (error) {
            console.error('❌ Erro ao marcar notificação como lida:', error);
        }
    }

    // Marcar todas como lidas
    async function marcarTodasLidas() {
        try {
            if (!currentUser) return;
            
            const response = await fetch(`${API_BASE}/api/notifications/read-all/${currentUser.id}`, {
                method: 'POST'
            });
            
            const data = await response.json();
            if (data.success) {
                loadNotifications();
                showToast(`${data.count} notificações marcadas como lidas`, 'success');
            }
        } catch (error) {
            console.error('❌ Erro ao marcar todas como lidas:', error);
        }
    }

    // Iniciar polling de notificações
    function startNotificationPolling() {
        if (notificationInterval) clearInterval(notificationInterval);
        
        notificationInterval = setInterval(async () => {
            if (currentUser) {
                try {
                    const response = await fetch(`${API_BASE}/api/notifications/count/${currentUser.id}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        updateNotificationBadge(data.count);
                    }
                } catch (error) {
                    console.error('❌ Erro no polling de notificações:', error);
                }
            }
        }, 30000); // 30 segundos
    }

    // ===== SISTEMA DE PROATIVIDADE =====

    // Carregar dados de proatividade
    async function loadProactiveData() {
        try {
            if (!currentTenant) return;
            
            const startTime = Date.now();
            showLoadingState();
            
            const [dashboardData, insightsData] = await Promise.all([
                fetch(`${API_BASE}/api/proactive/dashboard/${currentTenant.id}`).then(r => r.json()),
                fetch(`${API_BASE}/api/proactive/insights/${currentTenant.id}`).then(r => r.json())
            ]);
            
            if (dashboardData.success) {
                proactiveData = {
                    alerts: dashboardData.alerts || [],
                    actions: dashboardData.acoes || [],
                    risks: dashboardData.colaboradores_risco || [],
                    insights: insightsData.success ? insightsData.insights : []
                };
                
                renderProactiveDashboard();
                
                const loadTime = Date.now() - startTime;
                updateLastUpdate(loadTime);
                showToast('Dados atualizados com sucesso', 'success');
            }
        } catch (error) {
            console.error('❌ Erro ao carregar dados de proatividade:', error);
            showToast('Erro ao carregar dados', 'error');
        }
    }

    // Renderizar dashboard de proatividade
    function renderProactiveDashboard() {
        renderMetrics();
        renderAlerts();
        renderActions();
        renderRisks();
        renderInsights();
    }

    // Renderizar métricas
    function renderMetrics() {
        const { alerts, actions, risks } = proactiveData;
        
        // Alertas ativos
        const alertasAtivos = alerts.filter(a => a.status === 'ativo').length;
        animateValue('alertasAtivos', alertasAtivos);
        
        // Colaboradores em risco
        const riscosAltos = risks.filter(r => r.score >= 60).length;
        animateValue('colaboradoresRisco', riscosAltos);
        
        // Ações pendentes
        const pendentes = actions.filter(a => a.status === 'pendente_aprovacao').length;
        animateValue('acoesPendentes', pendentes);
        
        // Badges nos cards
        document.getElementById('alertasCriticosCount').textContent = alertasAtivos;
        document.getElementById('acoesPendentesCount').textContent = pendentes;
    }

    // Renderizar alertas
    function renderAlerts() {
        const container = document.getElementById('alertasCriticos');
        const alertas = proactiveData.alerts
            .filter(a => a.status === 'ativo' && a.severidade === 'critica')
            .slice(0, 5);

        if (alertas.length === 0) {
            container.innerHTML = '<p class="text-muted">Nenhum alerta crítico no momento 🎉</p>';
            return;
        }

        container.innerHTML = alertas.map(alerta => `
            <div class="activity-item action-card" data-id="${alerta.id}">
                <div class="activity-dot" style="color: #ef4444;"></div>
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 4px 0; font-size: 14px;">${alerta.titulo}</h4>
                        <p style="margin: 0 0 8px 0; color: #6b7280; font-size: 13px;">${alerta.anotacao}</p>
                        <div style="display: flex; gap: 8px; font-size: 12px; color: #9ca3af;">
                            <span>👤 ${alerta.colaborador_nome}</span>
                            <span>⏰ ${formatTimeAgo(alerta.created_at)}</span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn-sm btn-primary" onclick="viewAlertDetails('${alerta.id}')">
                            Ver
                        </button>
                        <button class="btn-sm btn-success" onclick="resolveAlert('${alerta.id}')">
                            Resolver
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Renderizar ações pendentes
    function renderActions() {
        const container = document.getElementById('acoesPendentesLista');
        const acoes = proactiveData.actions.filter(a => a.status === 'pendente_aprovacao').slice(0, 5);

        if (acoes.length === 0) {
            container.innerHTML = '<p class="text-muted">Nenhuma ação pendente</p>';
            return;
        }

        container.innerHTML = acoes.map(acao => `
            <div class="action-card" style="padding: 16px; border-bottom: 1px solid #e5e7eb;">
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 16px;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span class="badge badge-${getActionTypeBadge(acao.tipo_acao)}">${acao.tipo_acao}</span>
                            <h4 style="margin: 0; font-size: 14px;">${acao.titulo}</h4>
                        </div>
                        <p style="margin: 0 0 8px 0; color: #6b7280; font-size: 13px;">${acao.descricao}</p>
                        <details style="font-size: 12px; color: #9ca3af;">
                            <summary style="cursor: pointer;">Ver justificativa da IA</summary>
                            <p style="margin: 8px 0 0 0; padding: 8px; background: #f9fafb; border-radius: 4px;">
                                ${acao.justificativa_ia || 'Nenhuma justificativa disponível'}
                            </p>
                        </details>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-sm btn-success" onclick="approveAction('${acao.id}')">
                            <i data-feather="check"></i> Aprovar
                        </button>
                        <button class="btn-sm btn-danger" onclick="rejectAction('${acao.id}')">
                            <i data-feather="x"></i> Rejeitar
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        
        feather.replace();
    }

    // Renderizar riscos
    function renderRisks() {
        const container = document.getElementById('topRiscos');
        const topRisks = proactiveData.risks
            .sort((a, b) => b.score - a.score)
            .slice(0, 5);

        container.innerHTML = topRisks.map(risk => `
            <div class="risk-item" style="padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer;"
                 onclick="viewRiskDetails('${risk.id}')">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <strong style="font-size: 14px;">${risk.name}</strong>
                    <span class="badge badge-${getRiskLevel(risk.score)}">${risk.score}</span>
                </div>
                <div class="risk-score-bar">
                    <div class="risk-score-fill ${getRiskLevel(risk.score)}" 
                         style="width: ${risk.score}%;"></div>
                </div>
                <p style="margin: 8px 0 0 0; font-size: 12px; color: #6b7280;">
                    ${risk.principais_fatores ? risk.principais_fatores.slice(0, 2).join(', ') : 'Sem fatores identificados'}
                </p>
            </div>
        `).join('');
    }

    // Renderizar insights
    function renderInsights() {
        const container = document.getElementById('aiInsights');
        
        if (!proactiveData.insights || proactiveData.insights.length === 0) {
            container.innerHTML = '<div class="insight-item"><p class="insight-text">Analisando padrões...</p></div>';
            return;
        }

        container.innerHTML = proactiveData.insights.insights.map(insight => `
            <div class="insight-item">
                <h4 style="margin: 0 0 8px 0; font-size: 14px; color: var(--navi-primary-dark);">${insight.titulo}</h4>
                <p class="insight-text" style="margin: 0; font-size: 13px; color: #6b7280;">${insight.descricao}</p>
                <div style="margin-top: 8px;">
                    <span class="badge badge-${insight.impacto === 'alto' ? 'danger' : insight.impacto === 'medio' ? 'warning' : 'info'}">${insight.impacto}</span>
                </div>
            </div>
        `).join('');
    }

    // ===== FUNÇÕES AUXILIARES =====

    // Animar valores
    function animateValue(elementId, endValue) {
        const element = document.getElementById(elementId);
        const startValue = parseInt(element.textContent) || 0;
        const duration = 500;
        const startTime = Date.now();

        const animate = () => {
            const currentTime = Date.now();
            const progress = Math.min((currentTime - startTime) / duration, 1);
            const currentValue = Math.floor(startValue + (endValue - startValue) * progress);
            element.textContent = currentValue;

            if (progress < 1) requestAnimationFrame(animate);
        };

        animate();
    }

    // Mostrar estado de loading
    function showLoadingState() {
        // Implementar skeleton loading se necessário
    }

    // Atualizar última atualização
    function updateLastUpdate(loadTime) {
        const element = document.getElementById('lastUpdate');
        element.textContent = `Atualizado há ${Math.round(loadTime / 1000)}s`;
    }

    // Mostrar toast
    function showToast(message, type = 'info') {
        // Implementar toast notifications
        console.log(`Toast ${type}: ${message}`);
    }

    // Formatar tempo relativo
    function formatTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);
        
        if (diffInSeconds < 60) return 'agora';
        if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}min atrás`;
        if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h atrás`;
        return `${Math.floor(diffInSeconds / 86400)}d atrás`;
    }

    // Obter badge de tipo de ação
    function getActionTypeBadge(tipo) {
        const badges = {
            'contatar_colaborador': 'primary',
            'escalar_rh': 'warning',
            'ajustar_trilha': 'info',
            'criar_ticket': 'danger'
        };
        return badges[tipo] || 'secondary';
    }

    // Obter nível de risco
    function getRiskLevel(score) {
        if (score >= 80) return 'critical';
        if (score >= 60) return 'high';
        if (score >= 30) return 'medium';
        return 'low';
    }

    // ===== FUNÇÕES DE AÇÃO =====

    // Aprovar ação
    async function approveAction(actionId) {
        try {
            const response = await fetch(`${API_BASE}/api/proactive/actions/${actionId}/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ observacoes: 'Aprovado via dashboard' })
            });
            
            const data = await response.json();
            if (data.success) {
                showToast('Ação aprovada com sucesso', 'success');
                loadProactiveData();
            }
        } catch (error) {
            console.error('❌ Erro ao aprovar ação:', error);
            showToast('Erro ao aprovar ação', 'error');
        }
    }

    // Rejeitar ação
    async function rejectAction(actionId) {
        try {
            const response = await fetch(`${API_BASE}/api/proactive/actions/${actionId}/reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ motivo_rejeicao: 'Rejeitado via dashboard' })
            });
            
            const data = await response.json();
            if (data.success) {
                showToast('Ação rejeitada', 'success');
                loadProactiveData();
            }
        } catch (error) {
            console.error('❌ Erro ao rejeitar ação:', error);
            showToast('Erro ao rejeitar ação', 'error');
        }
    }

    // Resolver alerta
    async function resolveAlert(alertId) {
        try {
            const response = await fetch(`${API_BASE}/api/proactive/alerts/${alertId}/resolve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    resolucao: 'Resolvido via dashboard',
                    resolvido_por: currentUser.id
                })
            });
            
            const data = await response.json();
            if (data.success) {
                showToast('Alerta resolvido', 'success');
                loadProactiveData();
            }
        } catch (error) {
            console.error('❌ Erro ao resolver alerta:', error);
            showToast('Erro ao resolver alerta', 'error');
        }
    }

    // Ver detalhes do alerta
    function viewAlertDetails(alertId) {
        const alerta = proactiveData.alerts.find(a => a.id === alertId);
        if (alerta) {
            showModal('Detalhes do Alerta', `
                <h4>${alerta.titulo}</h4>
                <p>${alerta.anotacao}</p>
                <p><strong>Colaborador:</strong> ${alerta.colaborador_nome}</p>
                <p><strong>Severidade:</strong> ${alerta.severidade}</p>
                <p><strong>Score:</strong> ${alerta.proactive_score}</p>
            `);
        }
    }

    // Ver detalhes do risco
    function viewRiskDetails(riskId) {
        const risk = proactiveData.risks.find(r => r.id === riskId);
        if (risk) {
            showModal('Detalhes do Risco', `
                <h4>${risk.name}</h4>
                <p><strong>Score de Risco:</strong> ${risk.score}</p>
                <p><strong>Nível:</strong> ${risk.nivel_risco}</p>
                <p><strong>Fatores:</strong> ${risk.principais_fatores.join(', ')}</p>
            `);
        }
    }

    // Mostrar modal
    function showModal(title, content) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalBody').innerHTML = content;
        document.getElementById('detailsModal').style.display = 'flex';
    }

    // Fechar modal
    function closeModal() {
        document.getElementById('detailsModal').style.display = 'none';
    }

    // Filtrar dados por tipo
    function filterByType(type) {
        console.log(`Filtrando por tipo: ${type}`);
        // Implementar filtros específicos
    }

    // Filtrar dados de proatividade
    function filterProactiveData() {
        const filter = document.getElementById('proactive-filter').value;
        console.log(`Filtrando dados: ${filter}`);
        // Implementar filtros
    }

    // Toggle auto refresh
    function toggleAutoRefresh() {
        const btn = document.getElementById('autoRefreshBtn');
        const status = document.getElementById('autoRefreshStatus');
        
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            btn.style.color = '#6b7280';
            status.textContent = 'Auto-refresh: OFF';
        } else {
            autoRefreshInterval = setInterval(loadProactiveData, 30000);
            btn.style.color = 'var(--navi-accent-teal)';
            status.textContent = 'Auto-refresh: ON';
        }
    }

    // Mostrar histórico resolvido
    function showResolvedHistory() {
        console.log('Mostrando histórico de alertas resolvidos');
        // Implementar histórico
    }

    // Mostrar todos os riscos
    function showAllRisks() {
        console.log('Mostrando todos os riscos');
        // Implementar visualização completa
    }

    // ===== INICIALIZAÇÃO =====

    // Inicializar sistema de proatividade quando a página carregar
    document.addEventListener('DOMContentLoaded', function() {
        // Aguardar carregamento dos dados básicos
        setTimeout(() => {
            if (currentTenant) {
                loadProactiveData();
                startNotificationPolling();
            }
        }, 2000);
    });
        
    </script>
    
        <!-- Chat Widget Integration (WebSocket Version) -->
        <link href="css/chat-widget.css" rel="stylesheet">
        <script>
            // Initialize chat widget for dashboard
            document.addEventListener('DOMContentLoaded', function() {
                if (window.chatWidget) {
                    // Set dashboard context
                    window.chatWidget.setUserId('admin-demo');
                    window.chatWidget.setContext({
                        page: 'dashboard',
                        userType: 'admin'
                    });
                }
            });
        </script>
        
        <!-- Feather Icons - Brand Manual -->
        <script src="https://unpkg.com/feather-icons"></script>
        <script>
            feather.replace();
        </script>
        
        <!-- Chat Widget Scripts -->
        <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
        <script>
            // Carregar chat widget independentemente do Supabase
            document.addEventListener('DOMContentLoaded', async () => {
                console.log('🚀 Iniciando carregamento do chat widget...');
                
                // Função para carregar script com fallback
                const loadScript = (src, timeout = 5000) => {
                    return new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = src;
                        script.async = true;
                        
                        const timeoutId = setTimeout(() => {
                            console.warn(`⚠️ Timeout ao carregar ${src}`);
                            reject(new Error(`Timeout loading ${src}`));
                        }, timeout);
                        
                        script.onload = () => {
                            clearTimeout(timeoutId);
                            console.log(`✅ Script carregado: ${src}`);
                            resolve();
                        };
                        
                        script.onerror = () => {
                            clearTimeout(timeoutId);
                            console.error(`❌ Erro ao carregar ${src}`);
                            reject(new Error(`Failed to load ${src}`));
                        };
                        
                        document.head.appendChild(script);
                    });
                };
                
                // Verificar se Supabase CDN carregou (com timeout agressivo)
                try {
                    await Promise.race([
                        new Promise(resolve => {
                            const checkSupabase = () => {
                                if (typeof window.supabase !== 'undefined') {
                                    console.log('✅ Supabase CDN carregado');
                                    resolve();
                                } else {
                                    setTimeout(checkSupabase, 50);
                                }
                            };
                            checkSupabase();
                        }),
                        new Promise((_, reject) => {
                            setTimeout(() => reject(new Error('Supabase CDN timeout')), 2000);
                        })
                    ]);
                } catch (error) {
                    console.warn('⚠️ Supabase CDN não carregou:', error.message);
                }
                
                // SEMPRE carregar o chat widget (independente do Supabase)
                try {
                    await loadScript('/js/chat-widget.js', 5000);
                    console.log('✅ Chat widget carregado com sucesso');
                    
                    // Inicializar chat widget automaticamente
                    if (typeof HybridChatWidget !== 'undefined') {
                        console.log('🚀 Inicializando chat widget automaticamente...');
                        window.chatWidget = new HybridChatWidget();
                        console.log('✅ Chat widget inicializado automaticamente');
                    }
                } catch (error) {
                    console.error('❌ Falha crítica ao carregar chat widget:', error);
                }
                
                // Inicializar Supabase Realtime para notificações de admin
                try {
                    // Carregar usuário atual do localStorage ou sessionStorage
                    let currentAdminId = null;
                    
                    // Tentar pegar do localStorage
                    const savedUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
                    if (savedUser) {
                        try {
                            const userData = JSON.parse(savedUser);
                            currentAdminId = userData.id;
                            currentUser = userData; // Atualizar variável global
                            console.log('👤 Usuário carregado do storage:', currentAdminId);
                        } catch (e) {
                            console.warn('⚠️ Erro ao parsear usuário:', e);
                        }
                    }
                    
                    // Se não encontrou, usar ID do chat widget
                    if (!currentAdminId && window.chatWidget && window.chatWidget.userId) {
                        currentAdminId = window.chatWidget.userId;
                        console.log('👤 Usando ID do chat widget:', currentAdminId);
                    }
                    
                    // Se ainda não tem, usar ID fixo para demo
                    if (!currentAdminId) {
                        currentAdminId = '4ab6c765-bcfc-4280-84cd-3190fcf881c2'; // Admin demo
                        console.log('👤 Usando ID admin demo:', currentAdminId);
                    }
                    
                    // Usar URLs fixas do Supabase
                    const supabaseUrl = 'https://gxqwfltteimexngybwna.supabase.co';
                    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4cXdmbHR0ZWltZXhuZ3lid25hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjk2NTM1NDUsImV4cCI6MjA0NTIzMTU0NX0.iYGHXZpKhEfYEbwcMJttWiX6Go8k_9ULrNJ1LHWw1y0';
                    
                    // Supabase já carregado via CDN
                    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
                    
                    // Escutar notificações de urgência crítica em tempo real
                    
                    if (currentAdminId) {
                        console.log('🔔 Configurando Realtime para admin:', currentAdminId);
                        
                        supabaseClient
                                .channel('admin-notifications')
                                .on('postgres_changes', {
                                    event: 'INSERT',
                                    schema: 'public',
                                    table: 'admin_notifications',
                                    filter: `admin_id=eq.${currentAdminId}`
                                }, (payload) => {
                                    console.log('🚨 NOVA NOTIFICAÇÃO CRÍTICA RECEBIDA:', payload.new);
                                    showCriticalAlert(payload.new);
                                })
                                .subscribe();
                            
                        console.log('✅ Realtime configurado com sucesso');
                    } else {
                        console.warn('⚠️ Usuário atual não é admin, pulando configuração de Realtime');
                    }
                } catch (error) {
                    console.error('❌ Erro ao configurar Realtime:', error);
                }
                
                // Carregar chat-integration.js se disponível
                try {
                    await loadScript('/js/chat-integration.js', 3000);
                } catch (error) {
                    console.warn('⚠️ Chat integration não carregou, continuando sem ele');
                }
                
                console.log('🎉 Carregamento de scripts concluído');
            });
        </script>
</body>
</html>