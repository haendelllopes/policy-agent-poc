# üöÄ Proposta de Melhorias - Arquitetura de Dados

**Data:** 10 de outubro de 2025  
**Projeto:** Flowly - Sistema de Onboarding com IA  
**Objetivo:** Diferenciar o produto no mercado atrav√©s de personaliza√ß√£o e intelig√™ncia

---

## üìã √çndice

1. [Contexto](#contexto)
2. [Melhorias Propostas](#melhorias-propostas)
3. [Arquitetura de Dados](#arquitetura-de-dados)
4. [Plano de Implementa√ß√£o](#plano-de-implementa√ß√£o)
5. [Impacto Esperado](#impacto-esperado)

---

## üéØ Contexto

O Flowly atualmente oferece funcionalidades "mais do mesmo" comparado aos concorrentes. Para se diferenciar, precisamos implementar tr√™s pilares:

1. **Intelig√™ncia do Agente** - Sistema de mem√≥ria e aprendizado
2. **Personaliza√ß√£o Emocional** - Adapta√ß√£o ao sentimento do colaborador
3. **Segmenta√ß√£o Inteligente** - Trilhas por cargo e departamento

---

## üí° Melhorias Propostas

### 1. Bloco de Notas do Agente AI (Sistema de Mem√≥ria)

**Objetivo:** O agente deve aprender com as intera√ß√µes e sugerir melhorias ao longo do tempo.

**Funcionalidades:**
- Anotar sentimentos sobre trilhas durante conversas
- Registrar feedback sobre a empresa
- Identificar padr√µes de dificuldade
- Sugerir melhorias autom√°ticas para gestores

**Valor:** Intelig√™ncia de neg√≥cio baseada em feedback real dos colaboradores

---

### 2. An√°lise de Sentimento do Colaborador

**Objetivo:** Adaptar o comportamento do agente conforme o estado emocional do colaborador.

**Funcionalidades:**
- Mensurar sentimento desde o primeiro contato
- Rastrear evolu√ß√£o emocional durante o onboarding
- Adaptar tom de comunica√ß√£o (formal, casual, motivador)
- Detectar frustra√ß√£o e oferecer suporte proativo

**Valor:** Experi√™ncia humanizada e emp√°tica

---

### 3. Trilhas por Departamento & Cargo

**Objetivo:** Onboarding personalizado conforme cargo e departamento do colaborador.

**Funcionalidades:**
- Configurar trilhas espec√≠ficas por cargo/departamento
- Trilhas "para todos", "para alguns" ou "espec√≠ficas"
- Agente orienta automaticamente qual trilha realizar
- Exemplo: Coordenador de Dev ‚â† Desenvolvedor de Dev

**Valor:** Onboarding mais relevante e eficiente

---

## üóÑÔ∏è Arquitetura de Dados

### Estrutura Atual (Revis√£o)

#### Tabela `users`
```sql
id UUID PRIMARY KEY
tenant_id UUID
name VARCHAR(255)
email VARCHAR(255)
phone VARCHAR(50)
position_id UUID REFERENCES positions(id)  -- ‚úÖ J√° existe
department_id UUID REFERENCES departments(id)  -- ‚úÖ J√° existe
role VARCHAR(50) DEFAULT 'colaborador'  -- ‚úÖ J√° existe
onboarding_status VARCHAR(50)
onboarding_inicio DATE
onboarding_fim DATE
pontuacao_total INTEGER
created_at TIMESTAMP
updated_at TIMESTAMP
```

#### Tabela `trilhas`
```sql
id UUID PRIMARY KEY
tenant_id UUID
nome VARCHAR(255)
descricao TEXT
prazo_dias INTEGER
ordem INTEGER
ativo BOOLEAN
created_at TIMESTAMP
updated_at TIMESTAMP
```

#### Tabela `onboarding_improvements` ‚úÖ
```sql
-- J√° existe! Criada na migra√ß√£o 003
-- Usada pelo agente para registrar melhorias
id UUID PRIMARY KEY
tenant_id UUID
categoria VARCHAR(50)
prioridade VARCHAR(20)
titulo VARCHAR(255)
descricao TEXT
contexto JSONB
dados_analise JSONB
status VARCHAR(30)
-- ... outros campos
```

---

## üÜï Novas Tabelas e Modifica√ß√µes

### 1. **Bloco de Notas do Agente** - Tabela `agente_anotacoes`

```sql
CREATE TABLE agente_anotacoes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  
  -- Relacionamentos
  colaborador_id UUID REFERENCES users(id) ON DELETE CASCADE,
  trilha_id UUID REFERENCES trilhas(id) ON DELETE SET NULL,
  
  -- Tipo de anota√ß√£o
  tipo VARCHAR(50) NOT NULL CHECK (tipo IN (
    'sentimento_trilha',     -- Sentimento sobre uma trilha espec√≠fica
    'sentimento_empresa',    -- Sentimento sobre a empresa
    'dificuldade_conteudo',  -- Dificuldade relatada em conte√∫do
    'sugestao_colaborador',  -- Sugest√£o do colaborador
    'padrao_identificado',   -- Padr√£o identificado pelo agente
    'observacao_geral'       -- Observa√ß√£o geral
  )),
  
  -- Conte√∫do da anota√ß√£o
  titulo VARCHAR(255) NOT NULL,
  anotacao TEXT NOT NULL,
  
  -- An√°lise de sentimento da anota√ß√£o
  sentimento VARCHAR(20) CHECK (sentimento IN ('muito_positivo', 'positivo', 'neutro', 'negativo', 'muito_negativo')),
  intensidade_sentimento DECIMAL(3,2), -- 0.00 a 1.00
  
  -- Metadados
  contexto JSONB, -- {conversa_id, momento_onboarding, topico, etc}
  tags TEXT[], -- Array de tags para facilitar busca
  
  -- Controle
  relevante BOOLEAN DEFAULT true, -- Se a anota√ß√£o ainda √© relevante
  gerou_melhoria BOOLEAN DEFAULT false, -- Se j√° gerou uma sugest√£o de melhoria
  improvement_id UUID REFERENCES onboarding_improvements(id), -- Link com melhoria gerada
  
  -- Timestamps
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- √çndices
CREATE INDEX idx_agente_anotacoes_tenant ON agente_anotacoes(tenant_id);
CREATE INDEX idx_agente_anotacoes_colaborador ON agente_anotacoes(colaborador_id);
CREATE INDEX idx_agente_anotacoes_trilha ON agente_anotacoes(trilha_id);
CREATE INDEX idx_agente_anotacoes_tipo ON agente_anotacoes(tipo);
CREATE INDEX idx_agente_anotacoes_sentimento ON agente_anotacoes(sentimento);
CREATE INDEX idx_agente_anotacoes_relevante ON agente_anotacoes(tenant_id, relevante);
CREATE INDEX idx_agente_anotacoes_tags ON agente_anotacoes USING GIN(tags);
```

**Exemplo de uso:**
```json
{
  "tipo": "sentimento_trilha",
  "titulo": "Colaborador achou trilha de RH muito longa",
  "anotacao": "Durante conversa, o colaborador Jo√£o mencionou que a trilha de RH tem muito conte√∫do e est√° com dificuldade de completar no prazo.",
  "sentimento": "negativo",
  "intensidade_sentimento": 0.65,
  "contexto": {
    "conversa_id": "conv-123",
    "momento_onboarding": "dia_3",
    "topico": "prazo_trilha",
    "mensagem_original": "Essa trilha t√° muito grande..."
  },
  "tags": ["prazo", "volume_conteudo", "rh"]
}
```

---

### 2. **An√°lise de Sentimento** - Tabela `colaborador_sentimentos`

```sql
CREATE TABLE colaborador_sentimentos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  colaborador_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  
  -- Sentimento capturado
  sentimento VARCHAR(20) NOT NULL CHECK (sentimento IN (
    'muito_positivo',  -- üòÑ Entusiasmado, animado
    'positivo',        -- üôÇ Satisfeito, tranquilo
    'neutro',          -- üòê Indiferente
    'negativo',        -- üòü Preocupado, frustrado
    'muito_negativo'   -- üòû Desmotivado, ansioso
  )),
  
  -- Intensidade do sentimento (0.00 = fraco, 1.00 = muito forte)
  intensidade DECIMAL(3,2) NOT NULL DEFAULT 0.50,
  
  -- Contexto da captura
  origem VARCHAR(50) NOT NULL CHECK (origem IN (
    'primeiro_contato',      -- Primeira intera√ß√£o com agente
    'durante_conversa',      -- Durante conversa normal
    'pos_trilha',            -- Ap√≥s completar trilha
    'pos_quiz',              -- Ap√≥s realizar quiz
    'feedback_explicito',    -- Colaborador deu feedback direto
    'analise_automatica'     -- An√°lise autom√°tica de mensagens
  )),
  
  -- Dados da an√°lise
  mensagem_analisada TEXT, -- Mensagem que gerou a an√°lise
  fatores_detectados JSONB, -- {palavras_chave: [], tom: '', emojis: []}
  
  -- Contexto adicional
  trilha_id UUID REFERENCES trilhas(id),
  momento_onboarding VARCHAR(50), -- 'inicio', 'meio', 'fim'
  dia_onboarding INTEGER, -- Dia de onboarding (1, 2, 3...)
  
  -- A√ß√£o tomada pelo agente
  acao_agente VARCHAR(100), -- 'mudou_tom', 'ofereceu_ajuda', 'enviou_motivacao'
  resposta_adaptada TEXT, -- Como o agente adaptou a resposta
  
  -- Timestamps
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- √çndices
CREATE INDEX idx_colaborador_sentimentos_tenant ON colaborador_sentimentos(tenant_id);
CREATE INDEX idx_colaborador_sentimentos_colaborador ON colaborador_sentimentos(colaborador_id);
CREATE INDEX idx_colaborador_sentimentos_sentimento ON colaborador_sentimentos(sentimento);
CREATE INDEX idx_colaborador_sentimentos_origem ON colaborador_sentimentos(origem);
CREATE INDEX idx_colaborador_sentimentos_data ON colaborador_sentimentos(created_at);
CREATE INDEX idx_colaborador_sentimentos_colaborador_data ON colaborador_sentimentos(colaborador_id, created_at);
```

**Exemplo de uso:**
```json
{
  "sentimento": "negativo",
  "intensidade": 0.72,
  "origem": "durante_conversa",
  "mensagem_analisada": "T√° dif√≠cil entender esse conte√∫do, n√£o sei se vou conseguir...",
  "fatores_detectados": {
    "palavras_chave": ["dif√≠cil", "n√£o sei", "conseguir"],
    "tom": "inseguro",
    "emojis": ["üòï"],
    "confianca_analise": 0.85
  },
  "trilha_id": "uuid-trilha-rh",
  "momento_onboarding": "meio",
  "dia_onboarding": 4,
  "acao_agente": "ofereceu_ajuda_personalizada",
  "resposta_adaptada": "Entendo que est√° com dificuldade. Que tal eu te explicar de um jeito mais simples? Posso te ajudar com isso! üòä"
}
```

**Nova coluna em `users` - Sentimento Atual:**
```sql
ALTER TABLE users ADD COLUMN sentimento_atual VARCHAR(20) 
  CHECK (sentimento_atual IN ('muito_positivo', 'positivo', 'neutro', 'negativo', 'muito_negativo'));
  
ALTER TABLE users ADD COLUMN sentimento_atualizado_em TIMESTAMP WITH TIME ZONE;
```

---

### 3. **Trilhas por Cargo/Departamento** - Modifica√ß√µes em `trilhas`

```sql
-- Adicionar colunas de segmenta√ß√£o √† tabela trilhas
ALTER TABLE trilhas ADD COLUMN segmentacao_tipo VARCHAR(30) NOT NULL DEFAULT 'todos'
  CHECK (segmentacao_tipo IN ('todos', 'departamentos', 'cargos', 'departamentos_cargos'));

ALTER TABLE trilhas ADD COLUMN segmentacao_config JSONB;

-- Exemplos de configura√ß√£o:
-- Para todos: segmentacao_tipo = 'todos', segmentacao_config = null
-- Para departamentos espec√≠ficos: segmentacao_tipo = 'departamentos', 
--   segmentacao_config = {"department_ids": ["uuid1", "uuid2"]}
-- Para cargos espec√≠ficos: segmentacao_tipo = 'cargos',
--   segmentacao_config = {"position_ids": ["uuid1", "uuid2"]}
-- Para combina√ß√£o: segmentacao_tipo = 'departamentos_cargos',
--   segmentacao_config = {
--     "regras": [
--       {"department_id": "uuid-dev", "position_ids": ["uuid-coord", "uuid-gerente"]},
--       {"department_id": "uuid-rh", "position_ids": ["uuid-analista"]}
--     ]
--   }
```

**Tabela auxiliar para melhor performance (opcional):**
```sql
CREATE TABLE trilha_segmentacao (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  trilha_id UUID NOT NULL REFERENCES trilhas(id) ON DELETE CASCADE,
  
  -- Segmenta√ß√£o (pelo menos um deve estar preenchido)
  department_id UUID REFERENCES departments(id) ON DELETE CASCADE,
  position_id UUID REFERENCES positions(id) ON DELETE CASCADE,
  
  -- Se true, todos do departamento/cargo t√™m acesso
  -- Se false, √© uma exce√ß√£o (n√£o tem acesso)
  incluir BOOLEAN DEFAULT true,
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- Garante que n√£o haver√° duplicatas
  UNIQUE(trilha_id, department_id, position_id)
);

CREATE INDEX idx_trilha_segmentacao_trilha ON trilha_segmentacao(trilha_id);
CREATE INDEX idx_trilha_segmentacao_dept ON trilha_segmentacao(department_id);
CREATE INDEX idx_trilha_segmentacao_position ON trilha_segmentacao(position_id);
```

---

## üîÑ Fluxos de Integra√ß√£o

### Fluxo 1: Agente faz anota√ß√£o durante conversa

```
1. Colaborador envia mensagem ‚Üí N8N recebe
2. N8N analisa mensagem com Google Gemini (sentimento + contexto)
3. N8N registra em agente_anotacoes via API
4. Se anota√ß√£o for relevante ‚Üí registra tamb√©m em colaborador_sentimentos
5. N8N adapta resposta baseado no sentimento
6. Periodicamente (1x/semana), N8N analisa anota√ß√µes acumuladas
7. Gera sugest√µes em onboarding_improvements
```

### Fluxo 2: Captura de sentimento em tempo real

```
1. Mensagem chega ‚Üí An√°lise de sentimento (Google Gemini)
2. Registra em colaborador_sentimentos
3. Atualiza sentimento_atual em users
4. Agente verifica sentimento_atual antes de responder
5. Adapta tom da resposta:
   - muito_negativo ‚Üí Tom emp√°tico, oferece ajuda
   - negativo ‚Üí Tom compreensivo, sugest√µes
   - neutro ‚Üí Tom profissional padr√£o
   - positivo ‚Üí Tom motivador, reconhecimento
   - muito_positivo ‚Üí Tom celebrativo, parabeniza√ß√µes
```

### Fluxo 3: Roteamento de trilhas por cargo/departamento

```
1. Novo colaborador cadastrado com cargo e departamento
2. Sistema busca trilhas aplic√°veis:
   SELECT * FROM trilhas t
   WHERE t.tenant_id = $1
   AND t.ativo = true
   AND (
     t.segmentacao_tipo = 'todos'
     OR (t.segmentacao_tipo = 'departamentos' 
         AND t.segmentacao_config->>'department_ids' @> $2)
     OR (t.segmentacao_tipo = 'cargos' 
         AND t.segmentacao_config->>'position_ids' @> $3)
     OR (t.segmentacao_tipo = 'departamentos_cargos' 
         AND ... regras complexas ...)
   )
3. Cria registros em colaborador_trilhas
4. Agente orienta colaborador sobre suas trilhas
```

---

## üìä Queries √öteis

### An√°lise de sentimentos ao longo do tempo
```sql
SELECT 
  u.name,
  cs.sentimento,
  cs.intensidade,
  cs.dia_onboarding,
  cs.origem,
  cs.created_at
FROM colaborador_sentimentos cs
JOIN users u ON cs.colaborador_id = u.id
WHERE cs.colaborador_id = $1
ORDER BY cs.created_at DESC;
```

### Sentimento m√©dio por trilha
```sql
SELECT 
  t.nome,
  COUNT(DISTINCT cs.colaborador_id) as total_colaboradores,
  AVG(CASE 
    WHEN cs.sentimento = 'muito_positivo' THEN 5
    WHEN cs.sentimento = 'positivo' THEN 4
    WHEN cs.sentimento = 'neutro' THEN 3
    WHEN cs.sentimento = 'negativo' THEN 2
    WHEN cs.sentimento = 'muito_negativo' THEN 1
  END) as sentimento_medio
FROM trilhas t
LEFT JOIN colaborador_sentimentos cs ON cs.trilha_id = t.id
WHERE t.tenant_id = $1
GROUP BY t.id, t.nome
ORDER BY sentimento_medio DESC;
```

### Anota√ß√µes relevantes que ainda n√£o geraram melhorias
```sql
SELECT 
  aa.tipo,
  aa.titulo,
  aa.anotacao,
  aa.sentimento,
  COUNT(*) as frequencia
FROM agente_anotacoes aa
WHERE aa.tenant_id = $1
  AND aa.relevante = true
  AND aa.gerou_melhoria = false
  AND aa.created_at >= NOW() - INTERVAL '30 days'
GROUP BY aa.tipo, aa.titulo, aa.anotacao, aa.sentimento
HAVING COUNT(*) >= 3  -- Padr√£o: 3 ou mais ocorr√™ncias
ORDER BY frequencia DESC;
```

### Trilhas dispon√≠veis para um colaborador
```sql
SELECT 
  t.*
FROM trilhas t
JOIN users u ON u.tenant_id = t.tenant_id
WHERE u.id = $1
  AND t.ativo = true
  AND (
    t.segmentacao_tipo = 'todos'
    OR (t.segmentacao_tipo = 'departamentos' 
        AND t.segmentacao_config->'department_ids' @> 
            to_jsonb(ARRAY[u.department_id::text]))
    OR (t.segmentacao_tipo = 'cargos' 
        AND t.segmentacao_config->'position_ids' @> 
            to_jsonb(ARRAY[u.position_id::text]))
  );
```

---

## üöÄ Plano de Implementa√ß√£o

### Fase 1: Trilhas por Cargo/Departamento (Semana 1-2)
**Prioridade:** ALTA  
**Complexidade:** M√âDIA

**Tarefas:**
1. ‚úÖ Criar migra√ß√£o SQL com novas colunas em `trilhas`
2. ‚úÖ Criar tabela `trilha_segmentacao` (opcional)
3. ‚úÖ Atualizar API backend:
   - Endpoint para configurar segmenta√ß√£o de trilhas
   - Endpoint para buscar trilhas aplic√°veis a um colaborador
4. ‚úÖ Atualizar interface admin:
   - Tela de configura√ß√£o de trilhas com segmenta√ß√£o
   - Dropdown para selecionar departamentos/cargos
5. ‚úÖ Atualizar N8N workflow:
   - L√≥gica para determinar trilhas do colaborador
   - Orienta√ß√£o personalizada

**Entreg√°veis:**
- Migra√ß√£o SQL executada
- API funcional
- Interface admin atualizada
- Workflow N8N adaptado

---

### Fase 2: An√°lise de Sentimento (Semana 3-4)
**Prioridade:** ALTA  
**Complexidade:** M√âDIA-ALTA

**Tarefas:**
1. ‚úÖ Criar migra√ß√£o SQL:
   - Tabela `colaborador_sentimentos`
   - Novas colunas em `users`
2. ‚úÖ Integrar an√°lise de sentimento:
   - OpenAI API para an√°lise de texto
   - Ou Google Vertex AI (Natural Language API)
3. ‚úÖ Atualizar N8N workflow:
   - N√≥ de an√°lise de sentimento
   - L√≥gica de adapta√ß√£o de tom
   - Registro autom√°tico em banco
4. ‚úÖ Criar endpoints de API:
   - Hist√≥rico de sentimentos do colaborador
   - Sentimento atual
5. ‚úÖ Dashboard admin:
   - Visualiza√ß√£o de sentimentos
   - Gr√°ficos de evolu√ß√£o emocional
   - Alertas para sentimentos muito negativos

**Entreg√°veis:**
- Sistema de an√°lise de sentimento funcionando
- Agente adaptando tom de comunica√ß√£o
- Dashboard de monitoramento

---

### Fase 3: Bloco de Notas do Agente (Semana 5-6)
**Prioridade:** M√âDIA  
**Complexidade:** ALTA

**Tarefas:**
1. ‚úÖ Criar migra√ß√£o SQL:
   - Tabela `agente_anotacoes`
2. ‚úÖ Atualizar N8N workflow:
   - L√≥gica para criar anota√ß√µes relevantes
   - An√°lise peri√≥dica de padr√µes
   - Gera√ß√£o autom√°tica de melhorias
3. ‚úÖ Criar endpoints de API:
   - CRUD de anota√ß√µes
   - Busca por tags, tipo, sentimento
   - An√°lise de padr√µes
4. ‚úÖ Interface admin:
   - Visualiza√ß√£o de anota√ß√µes do agente
   - Insights autom√°ticos
   - Dashboard de melhorias sugeridas
5. ‚úÖ Integra√ß√£o com `onboarding_improvements`:
   - Link entre anota√ß√µes e melhorias
   - Workflow de aprova√ß√£o

**Entreg√°veis:**
- Sistema de mem√≥ria do agente funcionando
- Dashboard de insights
- Sugest√µes autom√°ticas de melhoria

---

## üìà Impacto Esperado

### M√©tricas de Sucesso

| M√©trica | Antes | Meta |
|---------|-------|------|
| **Taxa de Conclus√£o de Trilhas** | 70% | 85% |
| **Satisfa√ß√£o do Colaborador (NPS)** | 6.5/10 | 8.5/10 |
| **Tempo M√©dio de Onboarding** | 15 dias | 10 dias |
| **Redu√ß√£o de D√∫vidas Repetitivas** | - | 40% |
| **Melhorias Implementadas/M√™s** | 0 | 5-10 |

### Valor Agregado

**Para o Colaborador:**
- ‚ú® Experi√™ncia personalizada
- üí¨ Comunica√ß√£o emp√°tica
- üéØ Conte√∫do relevante para seu cargo

**Para o Gestor:**
- üìä Insights sobre processo de onboarding
- üîç Identifica√ß√£o de gargalos
- üöÄ Melhoria cont√≠nua automatizada

**Para o Produto:**
- üèÜ Diferencia√ß√£o competitiva clara
- üíé Valor percebido maior
- üìà Reten√ß√£o de clientes

---

## üîê Considera√ß√µes de Seguran√ßa e Privacidade

1. **LGPD/GDPR Compliance:**
   - Dados de sentimento s√£o considerados dados sens√≠veis
   - Necess√°rio consentimento expl√≠cito do colaborador
   - Implementar anonimiza√ß√£o em relat√≥rios agregados

2. **Reten√ß√£o de Dados:**
   - Anota√ß√µes: 2 anos
   - Sentimentos: 1 ano ap√≥s fim do onboarding
   - Pol√≠tica de exclus√£o autom√°tica

3. **Acesso:**
   - Anota√ß√µes sens√≠veis: apenas admin e sistema
   - Sentimentos agregados: gestores
   - Dados individuais: requerem permiss√£o especial

---

## üìö Pr√≥ximos Passos

1. ‚úÖ Revisar e aprovar esta proposta
2. ‚úÖ Priorizar fases de implementa√ß√£o
3. ‚úÖ Criar migra√ß√µes SQL
4. ‚úÖ Desenvolver APIs backend
5. ‚úÖ Atualizar workflows N8N
6. ‚úÖ Desenvolver interfaces admin
7. ‚úÖ Testar com grupo piloto
8. ‚úÖ Rollout gradual

---

**Criado por:** Haendell + AI Assistant  
**√öltima atualiza√ß√£o:** 10 de outubro de 2025

