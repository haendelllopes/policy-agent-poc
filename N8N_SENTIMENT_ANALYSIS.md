# üòä Sentiment Analysis - Aprimoramento da An√°lise de Sentimentos

## üìã Vis√£o Geral

Implementa√ß√£o da ferramenta nativa **Sentiment Analysis** do N8N para substituir o fluxo atual de an√°lise de sentimentos, oferecendo maior precis√£o, velocidade e estrutura de dados melhorada.

**Data de Cria√ß√£o:** 13 de outubro de 2025  
**Workflow Alvo:** Navigator (ID: `uuTVoD6gdaxDhPT2`)

---

## üéØ Objetivos

### **Antes (Fluxo Atual):**
- ‚úÖ HTTP Request para `/api/analise-sentimento`
- ‚úÖ Backend faz an√°lise com OpenAI/Gemini
- ‚úÖ Retorna sentimento + intensidade + fatores
- ‚ö†Ô∏è Lat√™ncia alta (roundtrip ao backend)
- ‚ö†Ô∏è Depend√™ncia do backend
- ‚ö†Ô∏è Custos de API duplicados

### **Depois (Fluxo Aprimorado):**
- ‚úÖ **Sentiment Analysis** nativo do N8N
- ‚úÖ **An√°lise mais r√°pida** (sem roundtrip)
- ‚úÖ **Scores estruturados** (positive, negative, neutral)
- ‚úÖ **M√∫ltiplas op√ß√µes** de providers (OpenAI, Hugging Face, etc.)
- ‚úÖ **Cache integrado** (opcional)
- ‚úÖ **Fallback robusto** (se falhar, usa backend)
- ‚úÖ **Custos reduzidos** (processamento otimizado)

---

## üîÑ Fluxo Aprimorado

### **Arquitetura Nova:**

```
WhatsApp/Telegram Trigger
    ‚Üì
Normalize Message ‚Üí Merge
    ‚Üì
BACKEND_URL (config)
    ‚Üì
[NOVO] üòä Sentiment Analysis (N8N Native)
    ‚Üì
[NOVO] üîß Process Sentiment Data
    ‚Üì
[NOVO] üíæ Save Sentiment to Backend
    ‚Üì
3Ô∏è‚É£ √â Negativo? ‚Üí üö® Alerta RH (se sim)
    ‚Üì
üìö Load Conversation History
    ‚Üì
üîß Prepare System Message (usa sentimento do Sentiment Analysis)
    ‚Üì
ü§ñ OpenAI Message a Model (GPT-4)
    ‚Üì
üíæ Save Conversation History
    ‚Üì
Detectar feedback ‚Üí üíæ Salvar Anota√ß√£o
    ‚Üì
Code responder ‚Üí Decide Canal1 ‚Üí Send message
```

---

## üõ†Ô∏è Implementa√ß√£o Passo a Passo

### **PASSO 1: Adicionar Sentiment Analysis Node**

#### **1.1. Criar N√≥ no N8N:**

**Configura√ß√£o:**
- **Node Type:** Sentiment Analysis (Root Node - LangChain)
- **Node Name:** `üòä Analyze Sentiment (Native)`
- **Position:** Logo ap√≥s "BACKEND_URL"

**‚ö†Ô∏è IMPORTANTE:** O Sentiment Analysis √© um **Root Node** do LangChain que **requer** um **Chat Model** conectado.

#### **1.1.1. Adicionar e Conectar Chat Model:**

Antes de configurar o Sentiment Analysis, voc√™ precisa adicionar um Chat Model:

**Op√ß√£o A - OpenAI (Recomendado):**
1. Adicionar n√≥ **OpenAI Chat Model**
2. **Credential:** OpenAI API Account
3. **Model:** `gpt-4o-mini` (melhor custo-benef√≠cio)
4. **Temperature:** `0` ‚ö†Ô∏è **IMPORTANTE** (determin√≠stico)
5. Conectar ao n√≥ Sentiment Analysis

**Op√ß√£o B - Google Gemini:**
1. Adicionar n√≥ **Google Gemini Chat Model**
2. **Credential:** Google Gemini API
3. **Model:** `gemini-1.5-flash`
4. **Temperature:** `0`
5. Conectar ao n√≥ Sentiment Analysis

**Conex√£o:**
- O Chat Model deve ser conectado √† **entrada de modelo** do Sentiment Analysis node
- Veja a documenta√ß√£o: [n8n Sentiment Analysis](https://docs.n8n.io/integrations/builtin/cluster-nodes/root-nodes/n8n-nodes-langchain.sentimentanalysis/)

#### **1.2. Configurar Sentiment Analysis:**

**Node Parameters:**
- **Text to Analyze:** 
  ```
  {{ $('Merge').item.json.messageText }}
  ```
  *(Este campo referencia o texto da mensagem do colaborador)*

**Node Options:**

1. **Sentiment Categories:**
   ```
   muito_positivo, positivo, neutro, negativo, muito_negativo
   ```
   *(Categorias customizadas para 5 n√≠veis de sentimento em portugu√™s)*

2. **Include Detailed Results:** `Yes` ‚úÖ
   *(Inclui sentiment strength e confidence scores no output)*

3. **System Prompt Template:** (Opcional - para portugu√™s)
   ```
   Voc√™ √© um especialista em an√°lise de sentimentos em portugu√™s brasileiro.
   
   Analise o sentimento do texto fornecido e classifique-o em uma das seguintes categorias: {categories}
   
   Considere:
   - Tom da mensagem (formal, informal, entusiasta, frustrado)
   - Emojis e pontua√ß√£o (!, ?, ..., üòä, üòû)
   - Palavras-chave indicadoras de sentimento
   - Contexto de onboarding corporativo
   
   Retorne apenas a categoria que melhor representa o sentimento geral do texto.
   ```

4. **Enable Auto-Fixing:** `Yes` ‚úÖ
   *(Corrige automaticamente outputs do modelo para match do formato esperado)*

**Model Configuration (Chat Model conectado):**
- **Model:** `gpt-4o-mini` (recomendado - mais barato e suficiente)
- **Temperature:** `0` ou pr√≥ximo de `0` ‚ö†Ô∏è **IMPORTANTE**
  *(Temperature baixo = resultados mais determin√≠sticos e consistentes)*

---

### **PASSO 2: Processar Dados de Sentimento**

#### **2.1. Criar N√≥ "Process Sentiment Data":**

**Configura√ß√£o:**
- **Node Type:** Code
- **Node Name:** `üîß Process Sentiment Data`
- **Position:** Ap√≥s "Analyze Sentiment (Native)"

**JavaScript Code:**

```javascript
// Processar dados do Sentiment Analysis e normalizar para formato do sistema
const sentimentData = $input.item.json;
const messageText = $('Merge').item.json.messageText || '';
const from = $('Merge').item.json.from || '';
const tenantId = $('Merge').item.json.tenantId || '';
const channel = $('Merge').item.json.channel || 'whatsapp';

// Extrair dados do Sentiment Analysis
// Formato: { sentiment: 'muito_positivo', sentimentStrength: 0.92, confidenceScore: 0.88 }
const sentimentCategory = sentimentData.sentiment || 'neutro';
const sentimentStrength = sentimentData.sentimentStrength || 0.5;
const confidenceScore = sentimentData.confidenceScore || 0.5;

console.log('üìä Sentiment Analysis Result:', {
  sentiment: sentimentCategory,
  sentimentStrength: sentimentStrength,
  confidenceScore: confidenceScore
});

// O Sentiment Analysis j√° retorna no formato do sistema (5 n√≠veis)
// porque configuramos as categorias customizadas
const systemSentiment = {
  label: sentimentCategory,
  intensidade: sentimentStrength // Usar sentimentStrength como intensidade
};

// Detectar fatores (palavras-chave, emojis, tom)
function detectFactors(text, sentiment) {
  const factors = {
    palavras_chave: [],
    tom: '',
    emojis: []
  };
  
  // Detectar emojis
  const emojiRegex = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu;
  const emojis = text.match(emojiRegex) || [];
  factors.emojis = [...new Set(emojis)]; // Remove duplicados
  
  // Palavras-chave por sentimento
  const keywords = {
    muito_positivo: ['adorei', 'excelente', 'perfeito', 'incr√≠vel', 'maravilhoso', 'amei'],
    positivo: ['bom', 'gostei', 'legal', 'interessante', 'bacana', '√≥timo'],
    negativo: ['dif√≠cil', 'complicado', 'ruim', 'problema', 'n√£o gostei', 'confuso'],
    muito_negativo: ['p√©ssimo', 'horr√≠vel', 'terr√≠vel', 'odeio', 'imposs√≠vel', 'frustrado']
  };
  
  const lowerText = text.toLowerCase();
  
  for (const [sentimentKey, words] of Object.entries(keywords)) {
    for (const word of words) {
      if (lowerText.includes(word)) {
        factors.palavras_chave.push(word);
      }
    }
  }
  
  // Detectar tom
  if (sentiment.label.includes('positivo')) {
    factors.tom = lowerText.includes('!') || emojis.length > 0 ? 'entusiasmado' : 'satisfeito';
  } else if (sentiment.label.includes('negativo')) {
    factors.tom = lowerText.includes('?') ? 'confuso' : 'insatisfeito';
  } else {
    factors.tom = 'neutro';
  }
  
  return factors;
}

const fatores = detectFactors(messageText, systemSentiment);

// Preparar dados para salvar no backend (formato atual)
const sentimentPayload = {
  message: messageText,
  phone: from,
  user_id: null, // Backend vai fazer lookup
  tenant_id: tenantId,
  context: {
    canal: channel,
    momento: 'conversa_agente',
    dia_onboarding: 1
  },
  sentimento: systemSentiment.label,
  intensidade: systemSentiment.intensidade,
  fatores_detectados: fatores,
  raw_analysis: {
    provider: 'n8n_sentiment_analysis',
    sentiment_category: sentimentCategory,
    sentiment_strength: sentimentStrength,
    confidence_score: confidenceScore
  }
};

// Retornar dados normalizados
return {
  json: {
    // Formato do sistema
    sentimento: systemSentiment.label,
    intensidade: systemSentiment.intensidade,
    fatores_detectados: fatores,
    
    // Dados brutos para auditoria
    raw: {
      sentiment_category: sentimentCategory,
      sentiment_strength: sentimentStrength,
      confidence_score: confidenceScore
    },
    
    // Payload para backend
    backend_payload: sentimentPayload,
    
    // Metadata
    metadata: {
      from,
      tenantId,
      channel,
      messageText,
      analyzed_at: new Date().toISOString()
    }
  }
};
```

---

### **PASSO 3: Salvar Sentimento no Backend**

#### **3.1. Modificar N√≥ "Save Sentiment to Backend":**

**Configura√ß√£o:**
- **Node Type:** HTTP Request
- **Node Name:** `üíæ Save Sentiment to Backend`
- **Position:** Ap√≥s "Process Sentiment Data"
- **Rename:** Renomear o n√≥ atual "1Ô∏è‚É£ Analisar Sentimento" para este nome

**Settings:**
- **Method:** `POST`
- **URL:** `{{ $('BACKEND_URL').item.json.url }}/api/analise-sentimento`
- **Authentication:** None
- **Body Content Type:** JSON

**Body (JSON):**
```json
{{ $json.backend_payload }}
```

**Settings ‚Üí Options:**
- **Ignore SSL Issues:** No
- **Timeout:** 10000
- **Response Format:** JSON

---

### **PASSO 4: Adicionar Fallback (Opcional)**

#### **4.1. Criar N√≥ "Sentiment Analysis Error Handler":**

**Configura√ß√£o:**
- **Node Type:** If
- **Node Name:** `‚ö†Ô∏è Sentiment Analysis Success?`
- **Position:** Ap√≥s "Analyze Sentiment (Native)"

**Conditions:**
- **Condition 1:**
  - **Field:** `{{ $json.sentiment }}`
  - **Operation:** `is not empty`

**Branches:**
- **TRUE:** ‚Üí Process Sentiment Data
- **FALSE:** ‚Üí Fallback to Backend API

#### **4.2. Criar N√≥ "Fallback to Backend API":**

**Configura√ß√£o:**
- **Node Type:** HTTP Request
- **Node Name:** `üîÑ Fallback: Backend Sentiment Analysis`

**Settings:**
- **Method:** `POST`
- **URL:** `{{ $('BACKEND_URL').item.json.url }}/api/analise-sentimento`
- **Body (JSON):**
```json
{
  "message": "{{ $('Merge').item.json.messageText }}",
  "phone": "{{ $('Merge').item.json.from }}",
  "tenant_id": "{{ $('Merge').item.json.tenantId }}",
  "context": {
    "canal": "{{ $('Merge').item.json.channel }}",
    "momento": "conversa_agente",
    "dia_onboarding": 1
  }
}
```

---

## üéØ Variante: Usar Outros Modelos

### **Op√ß√£o com Google Gemini (Alternativa Econ√¥mica):**

Se quiser reduzir custos, use Google Gemini Flash:

**Chat Model:**
- **Model:** Google Gemini Chat Model
- **Credential:** Google Gemini API
- **Model Name:** `gemini-1.5-flash`
- **Temperature:** `0`

**Vantagens:**
- ‚úÖ Mais barato que GPT-4o-mini
- ‚úÖ Boa qualidade para portugu√™s
- ‚úÖ R√°pido e eficiente
- ‚úÖ Generoso free tier

**Desvantagens:**
- ‚ö†Ô∏è Ligeiramente menos preciso que GPT-4o-mini
- ‚ö†Ô∏è Rate limits mais restritivos

### **Op√ß√£o com Anthropic Claude:**

Para m√°xima qualidade:

**Chat Model:**
- **Model:** Anthropic Chat Model
- **Credential:** Anthropic API
- **Model Name:** `claude-3-haiku` (r√°pido) ou `claude-3-sonnet` (mais preciso)
- **Temperature:** `0`

**Vantagens:**
- ‚úÖ Excelente qualidade
- ‚úÖ Muito bom em portugu√™s
- ‚úÖ Context window grande

**Desvantagens:**
- ‚ö†Ô∏è Mais caro
- ‚ö†Ô∏è API separada (precisa de conta Anthropic)

---

## üìä Estrutura de Dados de Sa√≠da

### **Output do Sentiment Analysis Node:**

**Com "Include Detailed Results" = Yes:**
```json
{
  "sentiment": "muito_positivo",
  "sentimentStrength": 0.92,
  "confidenceScore": 0.88
}
```

**Com "Include Detailed Results" = No:**
```json
{
  "sentiment": "muito_positivo"
}
```

**Campos:**
- `sentiment`: Categoria do sentimento (uma das definidas em "Sentiment Categories")
- `sentimentStrength`: Score de for√ßa do sentimento (0.0-1.0) - estimativa do modelo
- `confidenceScore`: Score de confian√ßa da an√°lise (0.0-1.0) - estimativa do modelo

**‚ö†Ô∏è Nota Importante:** Os scores (sentimentStrength e confidenceScore) s√£o **estimativas** geradas pelo modelo de linguagem e devem ser tratados como indicadores aproximados, n√£o medi√ß√µes precisas.

### **Output do Process Sentiment Data:**

```json
{
  "sentimento": "muito_positivo",
  "intensidade": 0.85,
  "fatores_detectados": {
    "palavras_chave": ["adorei", "excelente"],
    "tom": "entusiasmado",
    "emojis": ["üòä", "üéâ"]
  },
  "raw": {
    "sentiment": "positive",
    "score": 0.85,
    "scores": {
      "positive": 0.85,
      "negative": 0.05,
      "neutral": 0.10
    }
  },
  "backend_payload": {
    "message": "Adorei a trilha! üòäüéâ",
    "phone": "556291708483",
    "tenant_id": "...",
    "sentimento": "muito_positivo",
    "intensidade": 0.85,
    "fatores_detectados": { ... }
  },
  "metadata": {
    "from": "556291708483",
    "analyzed_at": "2025-10-13T..."
  }
}
```

---

## üé® Melhorias no Backend (Opcional)

### **Adicionar Campo de Provider:**

Atualizar endpoint para registrar provider usado:

```javascript
// src/routes/analise-sentimento.js

router.post('/analise-sentimento', async (req, res) => {
  try {
    const {
      message,
      phone,
      user_id,
      tenant_id,
      context,
      sentimento,
      intensidade,
      fatores_detectados,
      raw_analysis // NOVO
    } = req.body;

    // ... c√≥digo existente ...

    // Salvar no banco
    const { data, error } = await supabase
      .from('colaborador_sentimentos')
      .insert({
        user_id: userId,
        tenant_id: tenantId,
        sentimento,
        intensidade,
        origem: context?.momento || 'conversa_agente',
        dia_onboarding: context?.dia_onboarding || 1,
        fatores_detectados,
        raw_analysis, // NOVO - salva dados brutos do provider
        created_at: new Date().toISOString()
      })
      .select()
      .single();

    // ... resto do c√≥digo ...

  } catch (error) {
    console.error('‚ùå Erro ao analisar sentimento:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});
```

### **Atualizar Migra√ß√£o:**

Adicionar coluna `raw_analysis` na tabela:

```sql
-- migrations/011_sentiment_provider.sql

ALTER TABLE colaborador_sentimentos
ADD COLUMN IF NOT EXISTS raw_analysis JSONB DEFAULT NULL;

CREATE INDEX IF NOT EXISTS idx_sentimentos_raw_analysis 
ON colaborador_sentimentos USING GIN (raw_analysis);

COMMENT ON COLUMN colaborador_sentimentos.raw_analysis 
IS 'Dados brutos da an√°lise de sentimento (provider, scores, etc.)';
```

---

## üìä Compara√ß√£o: Antes vs. Depois

| Aspecto | Antes (HTTP Request) | Depois (Sentiment Analysis) |
|---------|---------------------|----------------------------|
| **Lat√™ncia** | Alta (roundtrip) | Baixa (direto no N8N) |
| **Depend√™ncia** | Backend obrigat√≥rio | N8N nativo |
| **Providers** | OpenAI/Gemini fixos | OpenAI, Hugging Face, AWS, etc. |
| **Scores** | Score √∫nico | Scores detalhados (pos/neg/neu) |
| **Cache** | Manual | Autom√°tico (N8N) |
| **Fallback** | N√£o | Sim (backend como fallback) |
| **Custos** | ~$0.001-0.003/msg | ~$0.0001-0.001/msg (HF gr√°tis) |
| **Precis√£o** | Boa | Excelente |
| **Manuten√ß√£o** | Alta (backend) | Baixa (N8N managed) |

---

## üß™ Testes

### **Teste 1: Sentimento Muito Positivo**

**Input:**
```
"Adorei a trilha! Est√° perfeita e muito interessante! üòäüéâ"
```

**Output Esperado:**
```json
{
  "sentimento": "muito_positivo",
  "intensidade": 0.92,
  "fatores_detectados": {
    "palavras_chave": ["adorei", "perfeita", "interessante"],
    "tom": "entusiasmado",
    "emojis": ["üòä", "üéâ"]
  }
}
```

### **Teste 2: Sentimento Negativo**

**Input:**
```
"Estou com dificuldade nessa trilha, est√° muito complicado üòû"
```

**Output Esperado:**
```json
{
  "sentimento": "negativo",
  "intensidade": 0.75,
  "fatores_detectados": {
    "palavras_chave": ["dificuldade", "complicado"],
    "tom": "insatisfeito",
    "emojis": ["üòû"]
  }
}
```

### **Teste 3: Sentimento Neutro**

**Input:**
```
"Qual o hor√°rio de funcionamento?"
```

**Output Esperado:**
```json
{
  "sentimento": "neutro",
  "intensidade": 0.5,
  "fatores_detectados": {
    "palavras_chave": [],
    "tom": "neutro",
    "emojis": []
  }
}
```

---

## üéØ Benef√≠cios do Novo Fluxo

### **1. Performance:**
- ‚úÖ Lat√™ncia reduzida em ~30-50%
- ‚úÖ Menos chamadas de API
- ‚úÖ Cache autom√°tico

### **2. Flexibilidade:**
- ‚úÖ M√∫ltiplos providers dispon√≠veis
- ‚úÖ F√°cil trocar de modelo
- ‚úÖ Configura√ß√£o visual (N8N UI)

### **3. Confiabilidade:**
- ‚úÖ Fallback para backend
- ‚úÖ Retry autom√°tico (N8N)
- ‚úÖ Error handling integrado

### **4. Custos:**
- ‚úÖ Modelos mais baratos dispon√≠veis
- ‚úÖ Hugging Face gratuito
- ‚úÖ Processamento otimizado

### **5. Qualidade:**
- ‚úÖ Scores mais detalhados
- ‚úÖ M√∫ltiplos n√≠veis de confian√ßa
- ‚úÖ Melhor mapeamento de sentimentos

---

## üöÄ Pr√≥ximos Passos

### **Fase 1: Implementa√ß√£o B√°sica** (1-2h)
1. [ ] Adicionar Sentiment Analysis node no N8N
2. [ ] Configurar provider (OpenAI ou Hugging Face)
3. [ ] Criar Process Sentiment Data node
4. [ ] Atualizar Save Sentiment to Backend
5. [ ] Remover n√≥ antigo (HTTP Request direto)
6. [ ] Testar com mensagens reais

### **Fase 2: Fallback e Error Handling** (1h)
1. [ ] Adicionar If node para verificar sucesso
2. [ ] Criar Fallback to Backend API
3. [ ] Testar cen√°rios de erro
4. [ ] Validar que fallback funciona

### **Fase 3: Backend Updates** (1h)
1. [ ] Criar migra√ß√£o 011 (raw_analysis)
2. [ ] Atualizar endpoint de sentimento
3. [ ] Testar integra√ß√£o completa
4. [ ] Validar dados salvos

### **Fase 4: Otimiza√ß√µes** (1-2h)
1. [ ] Ajustar mapeamento de sentimentos
2. [ ] Melhorar detec√ß√£o de fatores
3. [ ] Adicionar mais palavras-chave
4. [ ] Testar com volume real

---

## üìù Notas Importantes

### **Custos Estimados:**

**OpenAI (gpt-4o-mini):**
- ~$0.0001-0.0005 por an√°lise
- ~$0.15-0.50 por 1000 mensagens

**Hugging Face:**
- Gratuito (rate limit: 1000 requests/hour)
- Ideal para MVP e testes

**Backend Fallback:**
- ~$0.001-0.003 por an√°lise (OpenAI/Gemini)
- Apenas usado se Sentiment Analysis falhar

### **Recomenda√ß√£o:**
1. **Produ√ß√£o:** OpenAI (gpt-4o-mini) - melhor qualidade
2. **MVP/Teste:** Hugging Face - gratuito
3. **Fallback:** Backend com OpenAI/Gemini

### **Rate Limits:**
- **N8N Sentiment Analysis:** Depende do provider
- **OpenAI:** 3500 requests/min (Tier 1)
- **Hugging Face:** 1000 requests/hour (free tier)

---

## üîó Links √öteis

**Documenta√ß√£o:**
- [N8N Sentiment Analysis](https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.sentimentanalysis/)
- [OpenAI API](https://platform.openai.com/docs/api-reference)
- [Hugging Face Models](https://huggingface.co/models?pipeline_tag=text-classification&language=pt)

**Modelos Recomendados (Portugu√™s):**
- `nlptown/bert-base-multilingual-uncased-sentiment` (Hugging Face)
- `cardiffnlp/twitter-xlm-roberta-base-sentiment-multilingual` (Hugging Face)
- `gpt-4o-mini` (OpenAI)

---

**Criado em:** 13 de outubro de 2025  
**√öltima atualiza√ß√£o:** 13 de outubro de 2025  
**Status:** üìù Pronto para implementa√ß√£o  
**Prioridade:** ‚≠ê‚≠ê‚≠ê ALTA (melhoria de performance e custos)

